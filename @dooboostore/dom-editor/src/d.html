<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê°„ë‹¨í•œ ë“œë˜ê·¸ ì•¤ ë“œë¡­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .draggable {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* touch-action: none; ì œê±°í•˜ì—¬ ìŠ¤í¬ë¡¤ í—ˆìš© */
            -webkit-touch-callout: none;
            /* iOS ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë°©ì§€ */
            -webkit-tap-highlight-color: transparent;
            /* í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ ë°©ì§€ */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 50px;
            position: relative;
        }

        /* ë“œë˜ê·¸ ì¤€ë¹„ ì¤‘ì¼ ë•Œ ì „ì—­ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ ë° í„°ì¹˜ ë™ì‘ ì œí•œ */
        body.drag-preparing {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        /* ë“œë˜ê·¸ ì¤€ë¹„ ì¤‘ì¼ ë•Œë§Œ í„°ì¹˜ ë™ì‘ ì œí•œ */
        body.drag-preparing .draggable {
            touch-action: none !important;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ í´ë˜ìŠ¤ */
        .draggable.path-animating {
            transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 999;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .draggable.ghost-element {
            opacity: 0.3;
            pointer-events: none;
        }



        .draggable.slide-in {
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .draggable.slide-out {
            animation: slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
        }



        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .draggable.bounce {
            animation: bounce 0.6s ease-in-out;
        }

        /* ì¤‘ì²©ëœ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .draggable .draggable {
            margin-left: 20px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }

        .draggable .draggable .draggable {
            border-left-color: #28a745;
            background-color: #e8f5e8;
        }

        .draggable .draggable .draggable .draggable {
            border-left-color: #ffc107;
            background-color: #fff8e1;
        }

        .draggable:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ì„ íƒëœ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .draggable.selected {
            border-color: #ff6b35;
            background-color: #fff5f0;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.3);
        }

        /* ì„ íƒëœ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .container.selected {
            position: relative;
            border-color: #ff6b35;
            background-color: #fff5f0;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.3);
        }

        /* ì¡°ì‘ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .action-buttons {
            position: absolute;
            top: -40px;
            right: 0;
            display: flex;
            gap: 5px;
            z-index: 1002;
        }

        /* Root Containerì˜ ë²„íŠ¼ì€ ë‚´ë¶€ ìƒë‹¨ì— í‘œì‹œ */
        .container.selected .action-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* TagName ì…ë ¥ í•„ë“œ */
        .tag-input {
            position: absolute;
            top: -70px;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid #007bff;
            z-index: 1003;
        }

        .tag-input input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            width: 100px;
            margin-right: 5px;
        }

        .tag-input button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin: 0 2px;
        }

        .tag-input button:hover {
            background: #0056b3;
        }

        .tag-input button.cancel {
            background: #6c757d;
        }

        .tag-input button.cancel:hover {
            background: #545b62;
        }

        /* ì†ì„± í¸ì§‘ ì˜ì—­ */
        .property-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .property-panel.active {
            display: block;
        }

        .property-panel h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .property-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .property-row label {
            min-width: 80px;
            font-weight: bold;
            color: #495057;
        }

        .property-row input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .property-row button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-width: 60px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .attributes-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .attribute-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .attribute-item:last-child {
            border-bottom: none;
        }

        .children-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .child-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 5px;
            background: #f8f9fa;
            cursor: pointer;
        }

        .child-item:hover {
            background: #e9ecef;
        }

        .child-item:last-child {
            margin-bottom: 0;
        }

        .child-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .child-actions {
            display: flex;
            gap: 5px;
        }

        .attribute-item input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }

        .attribute-item button {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 50px;
        }

        .action-btn {
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 30px;
        }

        .action-btn:hover {
            background: #e55a2b;
            transform: scale(1.05);
        }

        .action-btn.delete {
            background: #dc3545;
        }

        .action-btn.delete:hover {
            background: #c82333;
        }

        .action-btn.move-up {
            background: #28a745;
        }

        .action-btn.move-up:hover {
            background: #218838;
        }

        .action-btn.move-down {
            background: #17a2b8;
        }

        .action-btn.move-down:hover {
            background: #138496;
        }

        .action-btn.add-child {
            background: #6f42c1;
        }

        .action-btn.add-child:hover {
            background: #5a32a3;
        }

        .action-btn.move-to-parent {
            background: #fd7e14;
        }

        .action-btn.move-to-parent:hover {
            background: #e8690b;
        }

        .action-btn.move-into-up {
            background: #20c997;
        }

        .action-btn.move-into-up:hover {
            background: #1ba085;
        }

        .action-btn.move-into-down {
            background: #e83e8c;
        }

        .action-btn.move-into-down:hover {
            background: #d91a72;
        }

        .action-btn.change-tag {
            background: #17a2b8;
        }

        .action-btn.change-tag:hover {
            background: #138496;
        }

        /* Root Container ì „ìš© ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .action-btn.root-add {
            background: #28a745;
        }

        .action-btn.root-add:hover {
            background: #218838;
        }

        .action-btn.root-clear {
            background: #dc3545;
        }

        .action-btn.root-clear:hover {
            background: #c82333;
        }

        .action-btn.root-save {
            background: #007bff;
        }

        .action-btn.root-save:hover {
            background: #0056b3;
        }

        .action-btn.root-load {
            background: #6c757d;
        }

        .action-btn.root-load:hover {
            background: #545b62;
        }

        .draggable.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .draggable.drag-over {
            border-color: #28a745;
            background-color: #d4edda;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
        }

        /* ë“œë¡­ ìœ„ì¹˜ë³„ í•˜ì´ë¼ì´íŠ¸ */
        .draggable.drag-over-before {
            border-top: 6px solid #28a745;
            background-color: #d4edda;
            position: relative;
        }

        .draggable.drag-over-before::before {
            content: "â†‘ ì•ì— ì‚½ì…";
            position: absolute;
            top: -25px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
        }

        .draggable.drag-over-after {
            border-bottom: 6px solid #28a745;
            background-color: #d4edda;
            position: relative;
        }

        .draggable.drag-over-after::after {
            content: "â†“ ë’¤ì— ì‚½ì…";
            position: absolute;
            bottom: -25px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
        }

        .draggable.drag-over-child {
            border: 3px solid #007bff;
            background-color: #e7f3ff;
            box-shadow: inset 0 0 15px rgba(0, 123, 255, 0.4);
            position: relative;
        }

        .draggable.drag-over-child::before {
            content: "ğŸ“ ìì‹ìœ¼ë¡œ ì‚½ì…";
            position: absolute;
            top: 5px;
            right: 10px;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
        }

        .container {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            margin: 10px;
            background-color: #fafafa;
        }

        .container.drag-over {
            border-color: #007bff;
            background-color: #e7f3ff;
        }

        .trash {
            background-color: #ffebee;
            border-color: #f44336;
            text-align: center;
            color: #d32f2f;
            font-weight: bold;
        }

        .trash.drag-over {
            background-color: #ffcdd2;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 250px;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <!-- HTML íƒœê·¸ ëª©ë¡ -->
    <datalist id="htmlTags">
        <option value="div">div - ì¼ë°˜ì ì¸ ì»¨í…Œì´ë„ˆ</option>
        <option value="span">span - ì¸ë¼ì¸ ì»¨í…Œì´ë„ˆ</option>
        <option value="p">p - ë¬¸ë‹¨</option>
        <option value="h1">h1 - ì œëª© 1</option>
        <option value="h2">h2 - ì œëª© 2</option>
        <option value="h3">h3 - ì œëª© 3</option>
        <option value="h4">h4 - ì œëª© 4</option>
        <option value="h5">h5 - ì œëª© 5</option>
        <option value="h6">h6 - ì œëª© 6</option>
        <option value="header">header - í—¤ë”</option>
        <option value="nav">nav - ë„¤ë¹„ê²Œì´ì…˜</option>
        <option value="main">main - ë©”ì¸ ì½˜í…ì¸ </option>
        <option value="section">section - ì„¹ì…˜</option>
        <option value="article">article - ì•„í‹°í´</option>
        <option value="aside">aside - ì‚¬ì´ë“œë°”</option>
        <option value="footer">footer - í‘¸í„°</option>
        <option value="ul">ul - ìˆœì„œì—†ëŠ” ëª©ë¡</option>
        <option value="ol">ol - ìˆœì„œìˆëŠ” ëª©ë¡</option>
        <option value="li">li - ëª©ë¡ ì•„ì´í…œ</option>
        <option value="a">a - ë§í¬</option>
        <option value="img">img - ì´ë¯¸ì§€</option>
        <option value="button">button - ë²„íŠ¼</option>
        <option value="input">input - ì…ë ¥</option>
        <option value="textarea">textarea - í…ìŠ¤íŠ¸ ì˜ì—­</option>
        <option value="select">select - ì„ íƒ</option>
        <option value="form">form - í¼</option>
        <option value="table">table - í…Œì´ë¸”</option>
        <option value="thead">thead - í…Œì´ë¸” í—¤ë“œ</option>
        <option value="tbody">tbody - í…Œì´ë¸” ë°”ë””</option>
        <option value="tr">tr - í…Œì´ë¸” í–‰</option>
        <option value="th">th - í…Œì´ë¸” í—¤ë” ì…€</option>
        <option value="td">td - í…Œì´ë¸” ë°ì´í„° ì…€</option>
    </datalist>

    <div class="debug" id="debug">ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¤€ë¹„</div>

    <h1>ê°„ë‹¨í•œ ë“œë˜ê·¸ ì•¤ ë“œë¡­</h1>

    <div style="text-align: center; margin: 20px 0;">
        <button onclick="saveData()"
            style="margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ’¾
            ë°ì´í„° ì €ì¥</button>
        <button onclick="loadData()"
            style="margin: 5px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“‚
            ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="addNewItem()"
            style="margin: 5px; padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer;">â•
            ìƒˆ ì•„ì´í…œ</button>
        <button onclick="clearAll()"
            style="margin: 5px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸
            ì „ì²´ ì‚­ì œ</button>
        <button onclick="loadSampleData()"
            style="margin: 5px; padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ¯
            ìƒ˜í”Œ ë°ì´í„°</button>
    </div>

    <!-- ì†ì„± í¸ì§‘ íŒ¨ë„ -->
    <div id="propertyPanel" class="property-panel">
        <h4 id="selectedElementTitle">ì„ íƒëœ ìš”ì†Œ ì—†ìŒ</h4>



        <!-- TagName í¸ì§‘ -->
        <div class="property-row" id="tagNameRow">
            <label>TagName:</label>
            <input type="text" id="tagNameInput" list="htmlTags" placeholder="íƒœê·¸ëª… ì…ë ¥">
            <button class="btn-primary" onclick="updateTagName()">ë³€ê²½</button>
        </div>

        <!-- í…ìŠ¤íŠ¸ ë…¸ë“œ í¸ì§‘ -->
        <div class="property-row" id="textNodeRow" style="display: none;">
            <label>í…ìŠ¤íŠ¸ ë‚´ìš©:</label>
            <textarea id="textContentInput" placeholder="í…ìŠ¤íŠ¸ ë‚´ìš© ì…ë ¥" rows="3"
                style="width: 100%; resize: vertical;"></textarea>
            <button class="btn-primary" onclick="updateTextContent()" style="margin-top: 5px;">ì €ì¥</button>
        </div>

        <!-- ìƒˆ ì†ì„± ì¶”ê°€ -->
        <div class="property-row">
            <label>ìƒˆ ì†ì„±:</label>
            <input type="text" id="newAttrName" placeholder="ì†ì„±ëª…">
            <input type="text" id="newAttrValue" placeholder="ì†ì„±ê°’">
            <button class="btn-success" onclick="addAttribute()">ì¶”ê°€</button>
        </div>

        <!-- ê¸°ì¡´ ì†ì„± ëª©ë¡ -->
        <div class="property-row">
            <label>ì†ì„± ëª©ë¡:</label>
        </div>
        <div id="attributesList" class="attributes-list">
            <div style="text-align: center; color: #6c757d; padding: 20px;">
                ìš”ì†Œë¥¼ ì„ íƒí•˜ë©´ ì†ì„±ì´ í‘œì‹œë©ë‹ˆë‹¤
            </div>
        </div>

        <!-- ìš”ì†Œ ì´ë™ -->
        <div class="property-row">
            <label>ìš”ì†Œ ì´ë™:</label>
        </div>
        <div class="property-row">
            <button class="btn-secondary" onclick="moveElementUp()" style="margin-right: 5px;">â¬†ï¸ ìœ„ë¡œ</button>
            <button class="btn-secondary" onclick="moveElementDown()" style="margin-right: 5px;">â¬‡ï¸ ì•„ë˜ë¡œ</button>
            <button class="btn-info" onclick="moveToParent()" style="margin-right: 5px;">â†—ï¸ ìƒìœ„ë¡œ</button>
        </div>
        <div class="property-row">
            <button class="btn-warning" onclick="moveToUpperSibling()" style="margin-right: 5px;">â†–ï¸ ìœ„ ìš”ì†Œ ìì‹</button>
            <button class="btn-warning" onclick="moveToLowerSibling()">â†™ï¸ ì•„ë˜ ìš”ì†Œ ìì‹</button>
        </div>

        <!-- ìì‹ ìš”ì†Œ ê´€ë¦¬ -->
        <div class="property-row">
            <label>ìì‹ ìš”ì†Œ ê´€ë¦¬:</label>
        </div>
        <div class="property-row">
            <button class="btn-success" onclick="addChildElement()" style="margin-right: 5px;">â• ìì‹ ìš”ì†Œ</button>
            <button class="btn-info" onclick="addTextNode()" style="margin-right: 5px;">ğŸ“ í…ìŠ¤íŠ¸</button>
            <button class="btn-danger" onclick="deleteSelectedElement()">ğŸ—‘ï¸ ìš”ì†Œ ì‚­ì œ</button>
        </div>
        <div class="property-row">
            <label>ìì‹ ìš”ì†Œ ëª©ë¡:</label>
        </div>
        <div id="childrenList" class="children-list">
            <div style="text-align: center; color: #6c757d; padding: 20px;">
                ìì‹ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <!-- Root Container -->
    <div id="rootContainer" class="container"
        style="min-height: 400px; border: 2px solid #007bff; background-color: #f8f9fa;">
        <h3 style="margin-top: 0; color: #007bff;">ï¿½1 ì‘ì—… ì˜ì—­</h3>

        <div class="draggable" id="item1">ğŸ“„ ì•„ì´í…œ 1</div>
        <div class="draggable" id="item2">ğŸ“„ ì•„ì´í…œ 2
            <div class="draggable" id="item2-1">ğŸ“„ ì•„ì´í…œ 2-1</div>
            <div class="draggable" id="item2-2">ğŸ“„ ì•„ì´í…œ 2-2
                <div class="draggable" id="item2-2-1">ğŸ“„ ì•„ì´í…œ 2-2-1</div>
            </div>
        </div>
        <div class="draggable" id="item3">ğŸ“„ ì•„ì´í…œ 3
            <div class="draggable" id="item3-1">ğŸ“„ ì•„ì´í…œ 3-1</div>
        </div>
        <div class="draggable" id="item4">ğŸ“„ ì•„ì´í…œ 4</div>
        <div class="draggable" id="item5">ğŸ“„ ì•„ì´í…œ 5</div>
    </div>



    <div class="container trash">
        <h3>ğŸ—‘ï¸ íœ´ì§€í†µ</h3>
        <p>ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ë©´ ì‚­ì œë©ë‹ˆë‹¤</p>
    </div>

    <script>
        let draggedElement = null;
        let isDragging = false;
        let startX, startY;
        let offsetX, offsetY;
        let selectedElement = null; // ì„ íƒëœ ìš”ì†Œ

        const debug = document.getElementById('debug');

        function updateDebug(message) {
            debug.textContent = message;
            console.log(message);
        }

        // ìˆœí™˜ ì°¸ì¡° ë°©ì§€
        function isDescendant(parent, child) {
            let node = parent.parentNode;
            while (node != null) {
                if (node === child) return true;
                node = node.parentNode;
            }
            return false;
        }

        // ë“œë¡­ ê°€ëŠ¥í•œì§€ í™•ì¸
        function canDrop(draggedElement, targetElement) {
            if (draggedElement === targetElement) return false;
            if (isDescendant(targetElement, draggedElement)) return false;
            return true;
        }

        // ë“œë¡­ ìœ„ì¹˜ ê²°ì • (ìƒë‹¨/ì¤‘ê°„/í•˜ë‹¨)
        function getDropPosition(clientY, targetElement) {
            const rect = targetElement.getBoundingClientRect();
            const relativeY = clientY - rect.top;
            const height = rect.height;

            console.log(`getDropPosition: clientY=${clientY}, rect.top=${rect.top}, relativeY=${relativeY}, height=${height}`);

            // ì¤‘ì²©ëœ ìš”ì†Œê°€ ìˆëŠ” ê²½ìš° ë” ê´€ëŒ€í•œ child ì˜ì—­ ì„¤ì •
            const hasChildren = targetElement.querySelector('.draggable') !== null;

            if (hasChildren) {
                // ìì‹ì´ ìˆëŠ” ê²½ìš°: ìƒë‹¨ 20%, ì¤‘ê°„ 60%, í•˜ë‹¨ 20%
                if (relativeY < height * 0.2) {
                    console.log('Position: before (has children)');
                    return 'before';
                }
                if (relativeY > height * 0.8) {
                    console.log('Position: after (has children)');
                    return 'after';
                }
                console.log('Position: child (has children)');
                return 'child';
            } else {
                // ìì‹ì´ ì—†ëŠ” ê²½ìš°: ìƒë‹¨ 25%, ì¤‘ê°„ 50%, í•˜ë‹¨ 25%
                if (relativeY < height * 0.25) {
                    console.log('Position: before (no children)');
                    return 'before';
                }
                if (relativeY > height * 0.75) {
                    console.log('Position: after (no children)');
                    return 'after';
                }
                console.log('Position: child (no children)');
                return 'child';
            }
        }

        // ë“œë˜ê·¸ í™œì„±í™” ê´€ë ¨ ë³€ìˆ˜ë“¤
        let dragActivationTimer = null;
        let isDragReady = false;
        let dragStartElement = null;
        let customDragElement = null;
        let isCustomDragging = false;
        let isHTML5Dragging = false;
        let dragStartPos = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };

        // ëª¨ë“  draggable ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function initDragAndDrop() {
            document.querySelectorAll('.draggable, .container').forEach(element => {
                // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ìš”ì†Œë§Œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€
                if (element.classList.contains('draggable')) {
                    // 1ì´ˆ ëŒ€ê¸° í›„ ë“œë˜ê·¸ í™œì„±í™”
                    element.draggable = false;

                    // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ë“œë˜ê·¸ í™œì„±í™” ì œì–´
                    element.addEventListener('mousedown', handleDragActivationStart);
                    element.addEventListener('mouseup', handleDragActivationEnd);
                    element.addEventListener('mouseleave', handleDragActivationEnd);
                    element.addEventListener('touchstart', handleDragActivationStart, { passive: false });
                    element.addEventListener('touchend', handleDragActivationEnd, { passive: false });
                    element.addEventListener('touchcancel', handleDragActivationEnd, { passive: false });

                    // ì‹¤ì œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ë“¤
                    element.addEventListener('dragstart', handleDragStart);
                    element.addEventListener('dragend', handleDragEnd);
                    element.addEventListener('touchmove', handleTouchMove, { passive: false });
                }

                // ëª¨ë“  ìš”ì†Œì— ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€ (draggableë„ ë“œë¡­ ê°€ëŠ¥)
                element.addEventListener('dragover', handleDragOver);
                element.addEventListener('dragleave', handleDragLeave);
                element.addEventListener('drop', handleDrop);
            });
        }

        // ë“œë˜ê·¸ í™œì„±í™” ì‹œì‘ (1ì´ˆ ëŒ€ê¸°)
        function handleDragActivationStart(e) {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨ (ë¶€ëª¨ ìš”ì†Œì˜ ë“œë˜ê·¸ í™œì„±í™” ë°©ì§€)
            e.stopPropagation();

            // ì•¡ì…˜ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ
            if (e.target.closest('.action-buttons')) {
                return;
            }

            // ì´ë¯¸ ë‹¤ë¥¸ ìš”ì†Œê°€ ë“œë˜ê·¸ ì¤€ë¹„ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (dragStartElement && dragStartElement !== e.currentTarget) {
                return;
            }

            dragStartElement = e.currentTarget;
            isDragReady = false;

            // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì‹œì‘ ìœ„ì¹˜ ì €ì¥
            if (e.type === 'mousedown') {
                dragStartPos = { x: e.clientX, y: e.clientY };
                const rect = dragStartElement.getBoundingClientRect();
                dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            } else if (e.type === 'touchstart') {
                const touch = e.touches[0];
                dragStartPos = { x: touch.clientX, y: touch.clientY };
                const rect = dragStartElement.getBoundingClientRect();
                dragOffset = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
            }

            // ìŠ¤í¬ë¡¤ ê°ì§€ë¥¼ ìœ„í•œ ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (passiveë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©)
            document.addEventListener('mousemove', handlePreDragMove);
            document.addEventListener('touchmove', handlePreDragMove, { passive: true });

            // 1ì´ˆ í›„ ë“œë˜ê·¸ í™œì„±í™”
            const delay = 500;
            dragActivationTimer = setTimeout(() => {
                if (dragStartElement) {
                    isDragReady = true;

                    // ì´ì œ ìŠ¤í¬ë¡¤ ë°©ì§€ ì ìš©
                    document.body.classList.add('drag-preparing');

                    // í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ ì ìš©
                    dragStartElement.style.webkitUserSelect = 'none';
                    dragStartElement.style.userSelect = 'none';
                    dragStartElement.style.webkitTouchCallout = 'none'; // iOS ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë°©ì§€

                    // HTML5 ë“œë˜ê·¸ í™œì„±í™” (PCìš©)
                    dragStartElement.draggable = true;

                    // ì‹œê°ì  í”¼ë“œë°± (ë“œë˜ê·¸ ì¤€ë¹„ë¨ì„ í‘œì‹œ)
                    dragStartElement.style.cursor = 'grab';
                    dragStartElement.style.opacity = '0.8';

                    updateDebug(`ë“œë˜ê·¸ ëª¨ë“œ í™œì„±í™”ë¨ (${delay}ms ëŒ€ê¸° ì™„ë£Œ)`);

                    // ì§„ë™ í”¼ë“œë°± (ëª¨ë°”ì¼)
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    // ì¦‰ì‹œ ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì‹œì‘ (í”Œë¡œíŒ… íš¨ê³¼)
                    startCustomDrag();

                    // ê¸°ì¡´ ì´ë™ ë¦¬ìŠ¤ë„ˆ ì œê±°í•˜ê³  ë“œë˜ê·¸ ì´ë™ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    document.removeEventListener('mousemove', handlePreDragMove);
                    document.removeEventListener('touchmove', handlePreDragMove);
                    document.addEventListener('mousemove', handleCustomDragMove);
                    document.addEventListener('touchmove', handleCustomDragMove, { passive: false });
                }
            }, delay);
        }

        // ë“œë˜ê·¸ í™œì„±í™” ì „ ì´ë™ ì²˜ë¦¬ (ìŠ¤í¬ë¡¤ ê°ì§€)
        function handlePreDragMove(e) {
            if (!dragStartElement) return;

            let currentX, currentY;
            if (e.type === 'mousemove') {
                currentX = e.clientX;
                currentY = e.clientY;
            } else if (e.type === 'touchmove') {
                const touch = e.touches[0];
                if (!touch) return;
                currentX = touch.clientX;
                currentY = touch.clientY;
            }

            // ì´ë™ ê±°ë¦¬ ê³„ì‚°
            const deltaX = Math.abs(currentX - dragStartPos.x);
            const deltaY = Math.abs(currentY - dragStartPos.y);

            // ìŠ¤í¬ë¡¤ë¡œ íŒë‹¨ë˜ëŠ” ê²½ìš° (ì£¼ë¡œ ì„¸ë¡œ ì´ë™ì´ í¬ê³ , ê°€ë¡œ ì´ë™ì´ ì‘ì€ ê²½ìš°)
            // ë˜ëŠ” ì¶©ë¶„í•œ ì´ë™ì´ ê°ì§€ëœ ê²½ìš°
            if ((deltaY > 15 && deltaY > deltaX * 1.5) || (deltaX > 20 || deltaY > 20)) {
                // ìŠ¤í¬ë¡¤ ë˜ëŠ” ì˜ë„ì ì¸ ì´ë™ìœ¼ë¡œ íŒë‹¨í•˜ì—¬ ë“œë˜ê·¸ í™œì„±í™” ì·¨ì†Œ
                if (dragActivationTimer) {
                    clearTimeout(dragActivationTimer);
                    dragActivationTimer = null;
                }

                // ì •ë¦¬
                document.removeEventListener('mousemove', handlePreDragMove);
                document.removeEventListener('touchmove', handlePreDragMove);

                // ìš”ì†Œ ìŠ¤íƒ€ì¼ ì›ìƒë³µêµ¬
                if (dragStartElement) {
                    dragStartElement.style.webkitUserSelect = '';
                    dragStartElement.style.userSelect = '';
                    dragStartElement.style.webkitTouchCallout = '';
                }

                dragStartElement = null;
                isDragReady = false;

                // ìŠ¤í¬ë¡¤ì¸ì§€ ë“œë˜ê·¸ì¸ì§€ êµ¬ë¶„í•˜ì—¬ ë©”ì‹œì§€ í‘œì‹œ
                if (deltaY > 15 && deltaY > deltaX * 1.5) {
                    updateDebug('ìŠ¤í¬ë¡¤ ê°ì§€ë¨ - ìì—°ìŠ¤ëŸ¬ìš´ ìŠ¤í¬ë¡¤ í—ˆìš©');
                } else {
                    updateDebug('ì´ë™ ê°ì§€ë¨ - ë“œë˜ê·¸ ì·¨ì†Œ');
                }
            }
        }

        // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì´ë™ ì²˜ë¦¬
        function handleCustomDragMove(e) {
            if (!isDragReady || !dragStartElement) return;

            let currentX, currentY;
            if (e.type === 'mousemove') {
                currentX = e.clientX;
                currentY = e.clientY;
            } else if (e.type === 'touchmove') {
                e.preventDefault();
                const touch = e.touches[0];
                currentX = touch.clientX;
                currentY = touch.clientY;
            }

            // ì´ë¯¸ ì»¤ìŠ¤í…€ ë“œë˜ê·¸ê°€ ì‹œì‘ëœ ìƒíƒœì—ì„œë§Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            if (isCustomDragging && customDragElement) {
                // í”Œë¡œíŒ… ìš”ì†Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                customDragElement.style.left = (currentX - dragOffset.x) + 'px';
                customDragElement.style.top = (currentY - dragOffset.y) + 'px';

                // ë“œë¡­ íƒ€ê²Ÿ í•˜ì´ë¼ì´íŠ¸ (í”Œë¡œíŒ… ìš”ì†Œ ì„ì‹œ ìˆ¨ê¹€)
                customDragElement.style.display = 'none';
                const elementBelow = document.elementFromPoint(currentX, currentY);
                customDragElement.style.display = '';

                // ê°€ì¥ êµ¬ì²´ì ì¸ draggable ìš”ì†Œ ì°¾ê¸°
                let dropTarget = null;
                if (elementBelow) {
                    if (elementBelow.classList && elementBelow.classList.contains('draggable')) {
                        dropTarget = elementBelow;
                    } else {
                        dropTarget = elementBelow.closest('.draggable, .container');
                    }
                }

                clearHighlights();
                if (dropTarget && dropTarget !== dragStartElement && canDrop(dragStartElement, dropTarget)) {
                    // ë“œë¡­ ìœ„ì¹˜ì— ë”°ë¥¸ ì‹œê°ì  í”¼ë“œë°± (CSS í´ë˜ìŠ¤ ì‚¬ìš©)
                    const position = calculateDropPosition(dropTarget, currentX, currentY);

                    if (position === 'before') {
                        dropTarget.classList.add('drag-over-before');
                    } else if (position === 'after') {
                        dropTarget.classList.add('drag-over-after');
                    } else if (position === 'child') {
                        dropTarget.classList.add('drag-over-child');
                    }

                    // ê¸°ë³¸ drag-over í´ë˜ìŠ¤ë„ ì¶”ê°€
                    dropTarget.classList.add('drag-over');
                }
            }
        }

        // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì‹œì‘
        function startCustomDrag() {
            if (!dragStartElement) return;

            isCustomDragging = true;
            draggedElement = dragStartElement;

            // ì„ íƒ í•´ì œ
            deselectElement();

            // í”Œë¡œíŒ… ë“œë˜ê·¸ ìš”ì†Œ ìƒì„±
            customDragElement = dragStartElement.cloneNode(true);
            customDragElement.style.position = 'fixed';
            customDragElement.style.pointerEvents = 'none';
            customDragElement.style.zIndex = '9999';
            customDragElement.style.opacity = '0.8';
            customDragElement.style.transform = 'rotate(5deg)';
            customDragElement.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';

            // ì´ˆê¸° ìœ„ì¹˜ë¥¼ ë“œë˜ê·¸ ì‹œì‘ ìœ„ì¹˜ë¡œ ì„¤ì •
            customDragElement.style.left = (dragStartPos.x - dragOffset.x) + 'px';
            customDragElement.style.top = (dragStartPos.y - dragOffset.y) + 'px';

            // ì•¡ì…˜ ë²„íŠ¼ ì œê±°
            const actionButtons = customDragElement.querySelector('.action-buttons');
            if (actionButtons) {
                actionButtons.remove();
            }

            document.body.appendChild(customDragElement);

            // ì›ë³¸ ìš”ì†Œ ìŠ¤íƒ€ì¼ ë³€ê²½
            dragStartElement.style.opacity = '0.3';
            dragStartElement.style.cursor = 'grabbing';

            updateDebug(`ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì‹œì‘: ${dragStartElement.id || 'unnamed'}`);
        }

        // ë“œë˜ê·¸ í™œì„±í™” ì¢…ë£Œ
        function handleDragActivationEnd(e) {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
            e.stopPropagation();

            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (dragActivationTimer) {
                clearTimeout(dragActivationTimer);
                dragActivationTimer = null;
            }

            // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener('mousemove', handlePreDragMove);
            document.removeEventListener('touchmove', handlePreDragMove);
            document.removeEventListener('mousemove', handleCustomDragMove);
            document.removeEventListener('touchmove', handleCustomDragMove);

            // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì¢…ë£Œ ì²˜ë¦¬
            if (isCustomDragging) {
                // ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì •ìƒ ì²˜ë¦¬, ì—†ìœ¼ë©´ ì •ë¦¬ë§Œ
                if (e && (e.type === 'mouseup' || e.type === 'touchend')) {
                    handleCustomDragEnd(e);
                } else {
                    cleanupCustomDrag();
                }
            } else if (dragStartElement) {
                // ë“œë˜ê·¸ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì›ìƒë³µêµ¬
                dragStartElement.draggable = false;
                dragStartElement.style.cursor = '';
                dragStartElement.style.opacity = '';
                dragStartElement.style.webkitUserSelect = '';
                dragStartElement.style.userSelect = '';
                dragStartElement.style.webkitTouchCallout = '';
            }

            // ìƒíƒœ ì´ˆê¸°í™”
            document.body.classList.remove('drag-preparing');
            dragStartElement = null;
            isDragReady = false;
        }

        // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì¢…ë£Œ
        function handleCustomDragEnd(e) {
            if (!isCustomDragging) return;

            let dropX, dropY;
            if (e.type === 'mouseup') {
                dropX = e.clientX;
                dropY = e.clientY;
            } else if (e.type === 'touchend') {
                const touch = e.changedTouches && e.changedTouches[0];
                if (touch) {
                    dropX = touch.clientX;
                    dropY = touch.clientY;
                } else {
                    // í„°ì¹˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    dropX = 0;
                    dropY = 0;
                }
            }

            // ì¢Œí‘œê°’ ê²€ì¦
            if (!isFinite(dropX) || !isFinite(dropY) || dropX < 0 || dropY < 0) {
                console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë“œë¡­ ì¢Œí‘œ:', { dropX, dropY });
                // ì •ë¦¬ë§Œ í•˜ê³  ë“œë¡­ ì²˜ë¦¬ëŠ” ê±´ë„ˆë›°ê¸°
                cleanupCustomDrag();
                return;
            }

            // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸° (í”Œë¡œíŒ… ìš”ì†Œ ì„ì‹œ ìˆ¨ê¹€)
            if (customDragElement) {
                customDragElement.style.display = 'none';
            }

            const elementBelow = document.elementFromPoint(dropX, dropY);
            console.log('elementFromPoint ê²°ê³¼:', elementBelow);

            // ê°€ì¥ êµ¬ì²´ì ì¸ draggable ìš”ì†Œ ì°¾ê¸° (ê°€ì¥ ê¹Šì€ ìì‹ë¶€í„°)
            let dropTarget = null;
            if (elementBelow) {
                // í´ë¦­ëœ ìš”ì†Œê°€ draggableì´ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                if (elementBelow.classList && elementBelow.classList.contains('draggable')) {
                    dropTarget = elementBelow;
                } else {
                    // ì•„ë‹ˆë©´ ê°€ì¥ ê°€ê¹Œìš´ draggable ë˜ëŠ” container ì°¾ê¸°
                    dropTarget = elementBelow.closest('.draggable, .container');
                }
            }

            console.log('ìµœì¢… ë“œë¡­ íƒ€ê²Ÿ:', dropTarget);

            // í”Œë¡œíŒ… ìš”ì†Œ ë‹¤ì‹œ í‘œì‹œ
            if (customDragElement) {
                customDragElement.style.display = '';
            }

            // ë“œë¡­ ì²˜ë¦¬
            if (dropTarget && dropTarget !== draggedElement && canDrop(draggedElement, dropTarget)) {
                // ë“œë¡­ ìœ„ì¹˜ ê³„ì‚°
                const position = calculateDropPosition(dropTarget, dropX, dropY);
                performDrop(draggedElement, dropTarget, position);
            }

            // ì •ë¦¬
            cleanupCustomDrag();
            updateDebug('ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì¢…ë£Œ');
        }

        // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ì •ë¦¬
        function cleanupCustomDrag() {
            // ì •ë¦¬
            if (customDragElement) {
                customDragElement.remove();
                customDragElement = null;
            }

            if (draggedElement) {
                draggedElement.style.opacity = '';
                draggedElement.style.cursor = '';
            }

            clearHighlights();
            draggedElement = null;
            isCustomDragging = false;
        }

        // ë“œë¡­ ìœ„ì¹˜ ê³„ì‚°
        function calculateDropPosition(targetElement, x, y) {
            const rect = targetElement.getBoundingClientRect();

            // ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ ìì‹ìœ¼ë¡œ
            if (targetElement.classList.contains('container') || targetElement === rootContainer) {
                return 'child';
            }

            // draggable ìš”ì†Œì˜ ê²½ìš°
            if (targetElement.classList.contains('draggable')) {
                // ìš”ì†Œì˜ ì¤‘ì•™ ì˜ì—­ (30%-70%)ì— ë“œë¡­í•˜ë©´ ìì‹ìœ¼ë¡œ, ê·¸ ì™¸ëŠ” before/after
                const topThreshold = rect.top + rect.height * 0.3;
                const bottomThreshold = rect.top + rect.height * 0.7;

                if (y >= topThreshold && y <= bottomThreshold) {
                    return 'child';
                } else if (y < topThreshold) {
                    return 'before';
                } else {
                    return 'after';
                }
            }

            return 'child';
        }

        // ë°ìŠ¤í¬í†± ë“œë˜ê·¸ ì´ë²¤íŠ¸
        function handleDragStart(e) {
            console.log('handleDragStart í˜¸ì¶œë¨:', e.target);

            // ê°€ì¥ ê°€ê¹Œìš´ draggable ìš”ì†Œ ì°¾ê¸°
            draggedElement = e.target.closest('.draggable');
            if (!draggedElement) {
                console.log('draggable ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }

            // HTML5 ë“œë˜ê·¸ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
            isHTML5Dragging = true;
            console.log('HTML5 ë“œë˜ê·¸ í”Œë˜ê·¸ ì„¤ì •ë¨');

            // ë“œë˜ê·¸ ì‹œì‘ì‹œ ì„ íƒ í•´ì œ
            deselectElement();

            draggedElement.classList.add('dragging');
            draggedElement.style.cursor = 'grabbing';
            updateDebug(`HTML5 ë“œë˜ê·¸ ì‹œì‘: ${draggedElement.id || 'unnamed'}`);

            // ë“œë˜ê·¸ ë°ì´í„° ì„¤ì •
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.cursor = '';
                draggedElement.style.opacity = '';
                draggedElement.draggable = false; // ë“œë˜ê·¸ ì¢…ë£Œ í›„ ë¹„í™œì„±í™”
            }
            clearHighlights();
            draggedElement = null;
            isDragReady = false;
            isHTML5Dragging = false;
            updateDebug('HTML5 ë“œë˜ê·¸ ì¢…ë£Œ');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();

            const target = e.currentTarget;

            if (!draggedElement || !canDrop(draggedElement, target)) {
                return;
            }

            clearHighlights();

            if (target.classList.contains('trash')) {
                target.classList.add('drag-over');
                return;
            }

            if (target.classList.contains('draggable')) {
                // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ì™€ ë™ì¼í•œ ìœ„ì¹˜ ê³„ì‚° ë¡œì§ ì‚¬ìš©
                const position = calculateDropPosition(target, e.clientX, e.clientY);

                console.log(`PC DragOver: ${target.id || 'unnamed'} - position: ${position}`);

                if (position === 'before') {
                    target.classList.add('drag-over-before');
                } else if (position === 'after') {
                    target.classList.add('drag-over-after');
                } else if (position === 'child') {
                    target.classList.add('drag-over-child');
                }

                target.classList.add('drag-over');

                // ë” ëª…í™•í•œ ë””ë²„ê·¸ ë©”ì‹œì§€
                const draggedId = draggedElement.id || 'unnamed';
                const targetId = target.id || 'unnamed';
                updateDebug(`PC: ${draggedId} -> ${targetId} (${position})`);
            } else if (target === rootContainer) {
                target.classList.add('drag-over');
                updateDebug('ë“œë˜ê·¸ ì˜¤ë²„: Root Container');
            }
        }

        function handleDragLeave(e) {
            e.stopPropagation();
            clearHighlights();
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const dropZone = e.currentTarget;
            clearHighlights();

            if (!draggedElement || !canDrop(draggedElement, dropZone)) {
                console.log('Drop cancelled: invalid drop');
                return;
            }

            // HTML5 ë“œë˜ê·¸ëŠ” ì¦‰ì‹œ í—ˆìš©, ì»¤ìŠ¤í…€ ë“œë˜ê·¸ëŠ” 1.5ì´ˆ ì§€ì—° ì²´í¬
            if (!isHTML5Dragging && !isDragReady && !isCustomDragging) {
                console.log('Drop cancelled: drag not ready (need 1.5s hold for custom drag)');
                updateDebug('ì»¤ìŠ¤í…€ ë“œë˜ê·¸: 1.5ì´ˆ í™€ë“œ í•„ìš”');
                return;
            }

            const draggedId = draggedElement.id || 'unnamed';
            const dropZoneId = dropZone.id || dropZone.className;

            console.log(`handleDrop: ${draggedId} -> ${dropZoneId}`);

            if (dropZone.classList.contains('trash')) {
                // íœ´ì§€í†µì— ë“œë¡­í•˜ë©´ ì‚­ì œ
                if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    draggedElement.remove();
                    updateDebug('ì•„ì´í…œ ì‚­ì œë¨');
                }
            } else if (dropZone.classList.contains('draggable')) {
                // ë‹¤ë¥¸ draggable ìš”ì†Œì— ë“œë¡­ (root container ë‚´ë¶€ì—ì„œë§Œ)
                if (rootContainer && rootContainer.contains(dropZone)) {
                    const position = getDropPosition(e.clientY, dropZone);
                    console.log(`Dropping ${draggedId} to ${dropZoneId} at position: ${position}`);
                    performDrop(draggedElement, dropZone, position);
                } else {
                    updateDebug('Root container ì™¸ë¶€ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } else if (dropZone === rootContainer) {
                // Root containerì— ì§ì ‘ ë“œë¡­
                dropZone.appendChild(draggedElement);
                updateDebug(`Root containerë¡œ ì´ë™`);
            } else {
                updateDebug('ìœ íš¨í•˜ì§€ ì•Šì€ ë“œë¡­ ìœ„ì¹˜ì…ë‹ˆë‹¤');
            }

            reinitializeDragAndDrop();
        }

        // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ (ì´ì œ handleDragActivationStartì—ì„œ ì²˜ë¦¬ë¨)
        function handleTouchStart(e) {
            // ë“œë˜ê·¸ í™œì„±í™” ì‹œìŠ¤í…œì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ í„°ì¹˜ ì •ë³´ë§Œ ì €ì¥
            if (!isDragReady) {
                return;
            }

            e.preventDefault();

            // ê°€ì¥ ê°€ê¹Œìš´ draggable ìš”ì†Œ ì°¾ê¸°
            draggedElement = e.target.closest('.draggable');
            if (!draggedElement) {
                return;
            }

            isDragging = false;

            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;

            const rect = draggedElement.getBoundingClientRect();
            offsetX = touch.clientX - rect.left;
            offsetY = touch.clientY - rect.top;

            updateDebug(`í„°ì¹˜ ë“œë˜ê·¸ ì‹œì‘: ${draggedElement.textContent}`);
            setTimeout(() => {
                if (draggedElement && !isDragging) {
                    isDragging = true;
                    draggedElement.classList.add('dragging');
                    draggedElement.style.position = 'fixed';
                    draggedElement.style.zIndex = '1000';
                    draggedElement.style.pointerEvents = 'none';
                    updateDebug('ëª¨ë°”ì¼ ë“œë˜ê·¸ ì‹œì‘');
                }
            }, 150);
        }

        function handleTouchMove(e) {
            if (!draggedElement) return;
            e.preventDefault();

            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - startX);
            const deltaY = Math.abs(touch.clientY - startY);

            // ìµœì†Œ ì´ë™ ê±°ë¦¬ ì²´í¬ (ëª¨ë°”ì¼ì—ì„œ ì„ íƒê³¼ ë“œë˜ê·¸ êµ¬ë¶„ì„ ìœ„í•´ ì„ê³„ê°’ ì¦ê°€)
            if (deltaX > 20 || deltaY > 20) {
                isDragging = true;
                draggedElement.classList.add('dragging');
                draggedElement.style.position = 'fixed';
                draggedElement.style.zIndex = '1000';
                draggedElement.style.pointerEvents = 'none';
                updateDebug('ëª¨ë°”ì¼ ë“œë˜ê·¸ ì‹œì‘');
            }

            if (isDragging) {
                // ìš”ì†Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                draggedElement.style.left = `${touch.clientX - offsetX}px`;
                draggedElement.style.top = `${touch.clientY - offsetY}px`;

                // ë“œë¡­ íƒ€ê²Ÿ í•˜ì´ë¼ì´íŠ¸
                clearHighlights();
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);

                // ê°€ì¥ ê°€ê¹Œìš´ draggable ë˜ëŠ” container ì°¾ê¸° (ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ ì œì™¸)
                let draggableTarget = elementBelow?.closest('.draggable');
                if (draggableTarget === draggedElement) {
                    // ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ ìì²´ë¼ë©´ ë¶€ëª¨ì—ì„œ ë‹¤ë¥¸ draggable ì°¾ê¸°
                    draggableTarget = elementBelow?.parentElement?.closest('.draggable');
                }

                const containerTarget = elementBelow?.closest('.container');

                if (draggableTarget && draggableTarget !== draggedElement && canDrop(draggedElement, draggableTarget)) {
                    const position = getDropPosition(touch.clientY, draggableTarget);
                    draggableTarget.classList.add(`drag-over-${position}`);
                    updateDebug(`ë“œë˜ê·¸ ì¤‘: ${draggableTarget.id || 'unnamed'} - ${position} ìœ„ì¹˜`);
                } else if (containerTarget === rootContainer) {
                    containerTarget.classList.add('drag-over');
                    updateDebug(`ë“œë˜ê·¸ ì¤‘: Root Container`);
                } else if (containerTarget?.classList.contains('trash')) {
                    containerTarget.classList.add('drag-over');
                    updateDebug(`ë“œë˜ê·¸ ì¤‘: íœ´ì§€í†µ`);
                }
            }
        }

        function handleTouchEnd(e) {
            if (!draggedElement) return;
            e.preventDefault();

            const touch = e.changedTouches[0];
            updateDebug('í„°ì¹˜ ì¢…ë£Œ');

            if (isDragging) {
                // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                let draggableTarget = elementBelow?.closest('.draggable');
                if (draggableTarget === draggedElement) {
                    // ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ ìì²´ë¼ë©´ ë¶€ëª¨ì—ì„œ ë‹¤ë¥¸ draggable ì°¾ê¸°
                    draggableTarget = elementBelow?.parentElement?.closest('.draggable');
                }
                const containerTarget = elementBelow?.closest('.container');

                if (draggableTarget && canDrop(draggedElement, draggableTarget)) {
                    // ë‹¤ë¥¸ draggable ìš”ì†Œì— ë“œë¡­ (root container ë‚´ë¶€ì—ì„œë§Œ)
                    if (rootContainer && rootContainer.contains(draggableTarget)) {
                        const position = getDropPosition(touch.clientY, draggableTarget);
                        performDrop(draggedElement, draggableTarget, position);
                    } else {
                        updateDebug('Root container ì™¸ë¶€ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                } else if (containerTarget) {
                    if (containerTarget.classList.contains('trash')) {
                        // íœ´ì§€í†µì— ë“œë¡­
                        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            draggedElement.remove();
                            updateDebug('ì•„ì´í…œ ì‚­ì œë¨');
                        }
                    } else if (containerTarget === rootContainer) {
                        // Root containerì— ë“œë¡­
                        containerTarget.appendChild(draggedElement);
                        updateDebug(`Root containerë¡œ ì´ë™`);
                    } else {
                        updateDebug('ìœ íš¨í•˜ì§€ ì•Šì€ ë“œë¡­ ìœ„ì¹˜ì…ë‹ˆë‹¤');
                    }
                }

                reinitializeDragAndDrop();
            }

            // ì •ë¦¬
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.position = '';
                draggedElement.style.left = '';
                draggedElement.style.top = '';
                draggedElement.style.zIndex = '';
                draggedElement.style.pointerEvents = '';
            }

            // ë“œë˜ê·¸ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ íƒ ê¸°ëŠ¥ ì‹¤í–‰
            if (!isDragging && draggedElement) {
                console.log('ëª¨ë°”ì¼ í„°ì¹˜ ì„ íƒ:', draggedElement);

                // Root Container í´ë¦­ í™•ì¸
                if (draggedElement === rootContainer) {
                    if (selectedElement === rootContainer) {
                        deselectElement();
                    } else {
                        selectElement(rootContainer);
                    }
                } else if (draggedElement.classList.contains('draggable')) {
                    // draggable ìš”ì†Œ ì„ íƒ
                    if (selectedElement === draggedElement) {
                        deselectElement();
                    } else {
                        selectElement(draggedElement);
                    }
                }
            }

            clearHighlights();
            draggedElement = null;
            isDragging = false;
            updateDebug('ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¤€ë¹„');
        }

        // ë“œë¡­ ì‹¤í–‰ (ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function performDrop(draggedElement, targetElement, position) {
            const draggedId = draggedElement.id || 'unnamed';
            const targetId = targetElement.id || 'unnamed';

            console.log(`performDrop: ${draggedId} -> ${targetId} (${position})`);

            // ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ë“œë¡­ ì‹¤í–‰
            animateDragDrop(draggedElement, targetElement, position, () => {
                const parent = targetElement.parentNode;

                switch (position) {
                    case 'before':
                        parent.insertBefore(draggedElement, targetElement);
                        updateDebug(`${draggedId} -> ${targetId} ì•ì— ì‚½ì…`);
                        break;
                    case 'after':
                        parent.insertBefore(draggedElement, targetElement.nextSibling);
                        updateDebug(`${draggedId} -> ${targetId} ë’¤ì— ì‚½ì…`);
                        break;
                    case 'child':
                        targetElement.appendChild(draggedElement);
                        updateDebug(`${draggedId} -> ${targetId} ë‚´ë¶€ì— ì‚½ì…`);
                        break;
                }
            });
        }

        // Root Container ì°¸ì¡°
        let rootContainer = null;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
        function reinitializeDragAndDrop() {
            // Root Container ì„¤ì •
            rootContainer = document.getElementById('rootContainer');
            if (!rootContainer) {
                console.error('Root container not found!');
                return;
            }

            console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡ ì‹œì‘');

            // ëª¨ë“  ìš”ì†Œì—ì„œ ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.querySelectorAll('[data-drag-initialized]').forEach(el => {
                el.removeAttribute('data-drag-initialized');
            });

            // Root Containerì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            rootContainer.setAttribute('data-drag-initialized', 'true');
            rootContainer.addEventListener('dragover', handleDragOver);
            rootContainer.addEventListener('dragleave', handleDragLeave);
            rootContainer.addEventListener('drop', handleDrop);
            rootContainer.addEventListener('click', handleElementClick);
            console.log('Root Container ì´ë²¤íŠ¸ ë“±ë¡ë¨');

            // ëª¨ë“  draggable ìš”ì†Œë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const draggableElements = rootContainer.querySelectorAll('.draggable');
            draggableElements.forEach(element => {
                element.setAttribute('data-drag-initialized', 'true');
                element.draggable = false; // 1ì´ˆ ëŒ€ê¸° í›„ í™œì„±í™”

                // ë“œë˜ê·¸ í™œì„±í™” ì´ë²¤íŠ¸ë“¤
                element.addEventListener('mousedown', handleDragActivationStart);
                element.addEventListener('mouseup', handleDragActivationEnd);
                element.addEventListener('mouseleave', handleDragActivationEnd);
                element.addEventListener('touchstart', handleDragActivationStart, { passive: false });
                element.addEventListener('touchend', handleDragActivationEnd, { passive: false });
                element.addEventListener('touchcancel', handleDragActivationEnd, { passive: false });

                // ì‹¤ì œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ë“¤
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
                element.addEventListener('touchmove', handleTouchMove, { passive: false });

                // ë“œë¡­ ì´ë²¤íŠ¸
                element.addEventListener('dragover', handleDragOver);
                element.addEventListener('dragleave', handleDragLeave);
                element.addEventListener('drop', handleDrop);

                // í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒ ê¸°ëŠ¥)
                element.addEventListener('click', handleElementClick);
            });

            // íœ´ì§€í†µì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const trashElement = document.querySelector('.trash');
            if (trashElement) {
                trashElement.setAttribute('data-drag-initialized', 'true');
                trashElement.addEventListener('dragover', handleDragOver);
                trashElement.addEventListener('dragleave', handleDragLeave);
                trashElement.addEventListener('drop', handleDrop);
            }

            // ë°°ê²½ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (í•œ ë²ˆë§Œ)
            if (!document.body.hasAttribute('data-background-click-initialized')) {
                document.body.setAttribute('data-background-click-initialized', 'true');
                document.body.addEventListener('click', handleBackgroundClick);
            }

            console.log(`ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ: ${draggableElements.length}ê°œ draggable ìš”ì†Œ`);
            updateDebug(`ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡: ${draggableElements.length}ê°œ ìš”ì†Œ`);
        }

        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearHighlights() {
            document.querySelectorAll('.drag-over, .drag-over-before, .drag-over-after, .drag-over-child').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-before', 'drag-over-after', 'drag-over-child');
            });
        }

        // ìš”ì†Œ ì„ íƒ ê¸°ëŠ¥
        function selectElement(element) {
            console.log('selectElement í˜¸ì¶œë¨:', element, element === rootContainer);

            // ê¸°ì¡´ ì„ íƒ í•´ì œ
            if (selectedElement) {
                selectedElement.classList.remove('selected');
                removeActionButtons(selectedElement);
            }

            // ìƒˆ ìš”ì†Œ ì„ íƒ
            selectedElement = element;
            if (selectedElement) {
                selectedElement.classList.add('selected');

                // Root Containerì¸ì§€ í™•ì¸í•´ì„œ ë‹¤ë¥¸ ë²„íŠ¼ ì„¸íŠ¸ í‘œì‹œ
                if (selectedElement === rootContainer) {
                    console.log('Root Container ë²„íŠ¼ ì¶”ê°€ ì¤‘...');
                    addRootContainerButtons(selectedElement);
                    updateDebug('ì‘ì—…ì˜ì—­ ì„ íƒë¨');
                    hidePropertyPanel(); // Root Container ì„ íƒì‹œ ì†ì„± íŒ¨ë„ ìˆ¨ê¹€
                } else {
                    console.log('ì¼ë°˜ ìš”ì†Œ ë²„íŠ¼ ì¶”ê°€ ì¤‘...');
                    addActionButtons(selectedElement);
                    updateDebug(`ì„ íƒë¨: ${selectedElement.id || 'unnamed'}`);
                    showPropertyPanel(selectedElement); // ì¼ë°˜ ìš”ì†Œ ì„ íƒì‹œ ì†ì„± íŒ¨ë„ í‘œì‹œ
                }
            }
        }

        // ì„ íƒ í•´ì œ
        function deselectElement() {
            if (selectedElement) {
                selectedElement.classList.remove('selected');
                removeActionButtons(selectedElement);
                selectedElement = null;
                updateDebug('ì„ íƒ í•´ì œ');
                hidePropertyPanel(); // ì„ íƒ í•´ì œì‹œ ì†ì„± íŒ¨ë„ ìˆ¨ê¹€
            }
        }

        // ì¡°ì‘ ë²„íŠ¼ ì¶”ê°€
        function addActionButtons(element) {
            // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
            removeActionButtons(element);

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'action-buttons';

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn delete';
            deleteBtn.innerHTML = 'ğŸ—‘ï¸';
            deleteBtn.title = 'ì‚­ì œ';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSelectedElement();
            };

            // ìœ„ë¡œ ì´ë™ ë²„íŠ¼
            const moveUpBtn = document.createElement('button');
            moveUpBtn.className = 'action-btn move-up';
            moveUpBtn.innerHTML = 'â†‘';
            moveUpBtn.title = 'ìœ„ë¡œ ì´ë™';
            moveUpBtn.onclick = (e) => {
                e.stopPropagation();
                moveElementUp();
            };

            // ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼
            const moveDownBtn = document.createElement('button');
            moveDownBtn.className = 'action-btn move-down';
            moveDownBtn.innerHTML = 'â†“';
            moveDownBtn.title = 'ì•„ë˜ë¡œ ì´ë™';
            moveDownBtn.onclick = (e) => {
                e.stopPropagation();
                moveElementDown();
            };

            // ìì‹ ìš”ì†Œ ì¶”ê°€ ë²„íŠ¼
            const addChildBtn = document.createElement('button');
            addChildBtn.className = 'action-btn add-child';
            addChildBtn.innerHTML = 'â•';
            addChildBtn.title = 'ìì‹ ìš”ì†Œ ì¶”ê°€';
            addChildBtn.onclick = (e) => {
                e.stopPropagation();
                addChildElement();
            };

            // í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€ ë²„íŠ¼
            const addTextBtn = document.createElement('button');
            addTextBtn.className = 'action-btn add-text';
            addTextBtn.innerHTML = 'ğŸ“';
            addTextBtn.title = 'í…ìŠ¤íŠ¸ ì¶”ê°€';
            addTextBtn.onclick = (e) => {
                e.stopPropagation();
                addTextNode();
            };

            // ë¶€ëª¨ë¡œ ì´ë™ ë²„íŠ¼
            const moveToParentBtn = document.createElement('button');
            moveToParentBtn.className = 'action-btn move-to-parent';
            moveToParentBtn.innerHTML = 'â¬†ï¸';
            moveToParentBtn.title = 'ë¶€ëª¨ë¡œ ì´ë™';
            moveToParentBtn.onclick = (e) => {
                e.stopPropagation();
                moveToParent();
            };

            // ìœ„ìª½ í˜•ì œì˜ ìì‹ìœ¼ë¡œ ì´ë™ ë²„íŠ¼ (ì¡°ê±´ë¶€)
            const previousSibling = element.previousElementSibling;
            let moveIntoUpBtn = null;
            if (previousSibling && previousSibling.classList.contains('draggable')) {
                moveIntoUpBtn = document.createElement('button');
                moveIntoUpBtn.className = 'action-btn move-into-up';
                moveIntoUpBtn.innerHTML = 'â‡¡';
                moveIntoUpBtn.title = 'ìœ„ìª½ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™';
                moveIntoUpBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveIntoSibling('up');
                };
            }

            // ì•„ë˜ìª½ í˜•ì œì˜ ìì‹ìœ¼ë¡œ ì´ë™ ë²„íŠ¼ (ì¡°ê±´ë¶€)
            const nextSibling = element.nextElementSibling;
            let moveIntoDownBtn = null;
            if (nextSibling && nextSibling.classList.contains('draggable')) {
                moveIntoDownBtn = document.createElement('button');
                moveIntoDownBtn.className = 'action-btn move-into-down';
                moveIntoDownBtn.innerHTML = 'â‡£';
                moveIntoDownBtn.title = 'ì•„ë˜ìª½ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™';
                moveIntoDownBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveIntoSibling('down');
                };
            }

            // ë²„íŠ¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
            buttonsContainer.appendChild(deleteBtn);
            buttonsContainer.appendChild(moveUpBtn);
            buttonsContainer.appendChild(moveDownBtn);
            if (moveIntoUpBtn) buttonsContainer.appendChild(moveIntoUpBtn);
            if (moveIntoDownBtn) buttonsContainer.appendChild(moveIntoDownBtn);
            buttonsContainer.appendChild(addChildBtn);
            buttonsContainer.appendChild(addTextBtn);
            buttonsContainer.appendChild(moveToParentBtn);

            element.appendChild(buttonsContainer);
        }

        // Root Containerìš© ì¡°ì‘ ë²„íŠ¼ ì¶”ê°€
        function addRootContainerButtons(element) {
            console.log('addRootContainerButtons í˜¸ì¶œë¨:', element);

            // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
            removeActionButtons(element);

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'action-buttons';
            console.log('ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìƒì„±ë¨');

            // ìš”ì†Œ ì¶”ê°€ ë²„íŠ¼
            const addItemBtn = document.createElement('button');
            addItemBtn.className = 'action-btn root-add';
            addItemBtn.innerHTML = 'â•';
            addItemBtn.title = 'ìƒˆ ìš”ì†Œ ì¶”ê°€';
            addItemBtn.onclick = (e) => {
                e.stopPropagation();
                addNewItem();
            };

            // í…ìŠ¤íŠ¸ ì¶”ê°€ ë²„íŠ¼
            const addTextBtn = document.createElement('button');
            addTextBtn.className = 'action-btn root-add-text';
            addTextBtn.innerHTML = 'ğŸ“';
            addTextBtn.title = 'í…ìŠ¤íŠ¸ ì¶”ê°€';
            addTextBtn.onclick = (e) => {
                e.stopPropagation();
                addTextToRoot();
            };

            // ëª¨ë‘ ì§€ìš°ê¸° ë²„íŠ¼
            const clearAllBtn = document.createElement('button');
            clearAllBtn.className = 'action-btn root-clear';
            clearAllBtn.innerHTML = 'ğŸ—‘ï¸';
            clearAllBtn.title = 'ëª¨ë‘ ì§€ìš°ê¸°';
            clearAllBtn.onclick = (e) => {
                e.stopPropagation();
                clearAll();
            };

            // ì €ì¥í•˜ê¸° ë²„íŠ¼
            const saveBtn = document.createElement('button');
            saveBtn.className = 'action-btn root-save';
            saveBtn.innerHTML = 'ğŸ’¾';
            saveBtn.title = 'ì €ì¥í•˜ê¸°';
            saveBtn.onclick = (e) => {
                e.stopPropagation();
                saveData();
            };

            // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
            const loadBtn = document.createElement('button');
            loadBtn.className = 'action-btn root-load';
            loadBtn.innerHTML = 'ğŸ“‚';
            loadBtn.title = 'ë¶ˆëŸ¬ì˜¤ê¸°';
            loadBtn.onclick = (e) => {
                e.stopPropagation();
                loadData();
            };

            buttonsContainer.appendChild(addItemBtn);
            buttonsContainer.appendChild(addTextBtn);
            buttonsContainer.appendChild(clearAllBtn);
            buttonsContainer.appendChild(saveBtn);
            buttonsContainer.appendChild(loadBtn);

            element.appendChild(buttonsContainer);
            console.log('Root Container ë²„íŠ¼ë“¤ì´ ì¶”ê°€ë¨:', buttonsContainer);
        }

        // ì¡°ì‘ ë²„íŠ¼ ì œê±°
        function removeActionButtons(element) {
            const existingButtons = element.querySelector('.action-buttons');
            if (existingButtons) {
                existingButtons.remove();
            }
        }

        // ì„ íƒëœ ìš”ì†Œ ì‚­ì œ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function deleteSelectedElement() {
            if (!selectedElement) return;

            if (confirm('ì„ íƒëœ ìš”ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const elementId = selectedElement.id || 'unnamed';
                const elementToDelete = selectedElement;

                // ì„ íƒ í•´ì œ
                selectedElement = null;

                // ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
                animateElementDelete(elementToDelete, () => {
                    elementToDelete.remove();
                    updateDebug(`ì‚­ì œë¨: ${elementId}`);
                    reinitializeDragAndDrop();
                });
            }
        }

        // ì„ íƒëœ ìš”ì†Œ ìœ„ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function moveElementUp() {
            if (!selectedElement) return;

            const parent = selectedElement.parentNode;
            const previousSibling = selectedElement.previousElementSibling;

            if (previousSibling && previousSibling.classList.contains('draggable')) {
                animateElementMove(selectedElement, 'up', () => {
                    parent.insertBefore(selectedElement, previousSibling);
                    updateDebug(`ìœ„ë¡œ ì´ë™: ${selectedElement.id || 'unnamed'}`);
                });

                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¬ì´ˆê¸°í™”
                setTimeout(() => {
                    reinitializeDragAndDrop();
                    selectElement(selectedElement);
                }, 600);
            } else {
                // ì´ë™í•  ìˆ˜ ì—†ì„ ë•Œ bounce ì• ë‹ˆë©”ì´ì…˜
                selectedElement.classList.add('bounce');
                setTimeout(() => selectedElement.classList.remove('bounce'), 600);
                updateDebug('ë” ì´ìƒ ìœ„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        // ì„ íƒëœ ìš”ì†Œ ì•„ë˜ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function moveElementDown() {
            if (!selectedElement) return;

            const parent = selectedElement.parentNode;
            const nextSibling = selectedElement.nextElementSibling;

            if (nextSibling && nextSibling.classList.contains('draggable')) {
                animateElementMove(selectedElement, 'down', () => {
                    parent.insertBefore(nextSibling, selectedElement);
                    updateDebug(`ì•„ë˜ë¡œ ì´ë™: ${selectedElement.id || 'unnamed'}`);
                });

                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¬ì´ˆê¸°í™”
                setTimeout(() => {
                    reinitializeDragAndDrop();
                    selectElement(selectedElement);
                }, 600);
            } else {
                // ì´ë™í•  ìˆ˜ ì—†ì„ ë•Œ bounce ì• ë‹ˆë©”ì´ì…˜
                selectedElement.classList.add('bounce');
                setTimeout(() => selectedElement.classList.remove('bounce'), 600);
                updateDebug('ë” ì´ìƒ ì•„ë˜ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        // ì„ íƒëœ ìš”ì†Œì— ìì‹ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function addChildElement() {
            if (!selectedElement) return;

            const newId = `child-${itemCounter++}`;
            const newChild = document.createElement('div');
            newChild.className = 'draggable';
            newChild.id = newId;
            newChild.textContent = `ğŸ“„ ìƒˆ ìì‹ ${itemCounter - 1000}`;

            // ìì‹ ìš”ì†Œë¥¼ ì„ íƒëœ ìš”ì†Œì— ì¶”ê°€
            selectedElement.appendChild(newChild);

            // ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            animateElementAdd(newChild);

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            reinitializeDragAndDrop();

            updateDebug(`ìì‹ ì¶”ê°€: ${newId} -> ${selectedElement.id || 'unnamed'}`);
        }

        // ì„ íƒëœ ìš”ì†Œë¥¼ ë¶€ëª¨ ë ˆë²¨ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function moveToParent() {
            if (!selectedElement) return;

            const currentParent = selectedElement.parentNode;

            // Root Containerê°€ ë¶€ëª¨ì¸ ê²½ìš° ë” ì´ìƒ ì˜¬ë¼ê°ˆ ìˆ˜ ì—†ìŒ
            if (currentParent === rootContainer) {
                selectedElement.classList.add('bounce');
                setTimeout(() => selectedElement.classList.remove('bounce'), 600);
                updateDebug('ì´ë¯¸ ìµœìƒìœ„ ë ˆë²¨ì…ë‹ˆë‹¤');
                return;
            }

            // ë¶€ëª¨ì˜ ë¶€ëª¨ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const grandParent = currentParent.parentNode;
            if (!grandParent) {
                selectedElement.classList.add('bounce');
                setTimeout(() => selectedElement.classList.remove('bounce'), 600);
                updateDebug('ë” ì´ìƒ ìƒìœ„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ë¶€ëª¨ ë ˆë²¨ë¡œ ì´ë™
            animateElementMove(selectedElement, 'parent', () => {
                // í˜„ì¬ ë¶€ëª¨ì˜ ë°”ë¡œ ë‹¤ìŒ ìœ„ì¹˜ì— ì‚½ì…
                grandParent.insertBefore(selectedElement, currentParent.nextSibling);
                updateDebug(`ë¶€ëª¨ë¡œ ì´ë™: ${selectedElement.id || 'unnamed'} -> ${grandParent.id || grandParent.className}`);
            });

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¬ì´ˆê¸°í™”
            setTimeout(() => {
                reinitializeDragAndDrop();
                selectElement(selectedElement);
            }, 600);
        }

        // ì„ íƒëœ ìš”ì†Œë¥¼ í˜•ì œ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function moveIntoSibling(direction) {
            if (!selectedElement) return;

            const targetSibling = direction === 'up' ?
                selectedElement.previousElementSibling :
                selectedElement.nextElementSibling;

            if (!targetSibling || !targetSibling.classList.contains('draggable')) {
                selectedElement.classList.add('bounce');
                setTimeout(() => selectedElement.classList.remove('bounce'), 600);
                updateDebug(`${direction === 'up' ? 'ìœ„ìª½' : 'ì•„ë˜ìª½'} í˜•ì œ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤`);
                return;
            }

            // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ í˜•ì œ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™
            animateElementMove(selectedElement, `into-${direction}`, () => {
                targetSibling.appendChild(selectedElement);
                updateDebug(`${direction === 'up' ? 'ìœ„ìª½' : 'ì•„ë˜ìª½'} í˜•ì œì˜ ìì‹ìœ¼ë¡œ ì´ë™: ${selectedElement.id || 'unnamed'} -> ${targetSibling.id || 'unnamed'}`);
            });

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¬ì´ˆê¸°í™”
            setTimeout(() => {
                reinitializeDragAndDrop();
                selectElement(selectedElement);
            }, 600);
        }

        // TagName ì…ë ¥ UI í‘œì‹œ
        function showTagNameInput(element) {
            // ê¸°ì¡´ ì…ë ¥ UI ì œê±°
            hideTagNameInput();

            const inputContainer = document.createElement('div');
            inputContainer.className = 'tag-input';
            inputContainer.id = 'tagNameInput';

            const currentTag = element.tagName.toLowerCase();

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTag;
            input.list = 'htmlTags';
            input.placeholder = 'tagName';
            input.id = 'tagNameField';

            const confirmBtn = document.createElement('button');
            confirmBtn.innerHTML = 'âœ“';
            confirmBtn.title = 'í™•ì¸';
            confirmBtn.onclick = (e) => {
                e.stopPropagation();
                changeElementTagName(element, input.value.trim());
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel';
            cancelBtn.innerHTML = 'âœ•';
            cancelBtn.title = 'ì·¨ì†Œ';
            cancelBtn.onclick = (e) => {
                e.stopPropagation();
                hideTagNameInput();
            };

            inputContainer.appendChild(input);
            inputContainer.appendChild(confirmBtn);
            inputContainer.appendChild(cancelBtn);

            element.appendChild(inputContainer);

            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            input.focus();
            input.select();

            // Enter í‚¤ë¡œ í™•ì¸
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.stopPropagation();
                    changeElementTagName(element, input.value.trim());
                } else if (e.key === 'Escape') {
                    e.stopPropagation();
                    hideTagNameInput();
                }
            });

            updateDebug(`TagName ë³€ê²½ ëª¨ë“œ: ${currentTag}`);
        }

        // TagName ì…ë ¥ UI ìˆ¨ê¸°ê¸° (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ì†ì„± íŒ¨ë„ì˜ ì¼ë¶€ì´ë¯€ë¡œ)
        function hideTagNameInput() {
            // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ tagNameInputì„ ì œê±°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            // tagNameInputì€ ì†ì„± íŒ¨ë„ì˜ ì¼ë¶€ì´ë¯€ë¡œ í•­ìƒ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
        }

        // ìš”ì†Œì˜ TagName ë³€ê²½
        function changeElementTagName(oldElement, newTagName) {
            if (!newTagName || newTagName === oldElement.tagName.toLowerCase()) {
                return;
            }

            // ìœ íš¨í•œ HTML íƒœê·¸ëª…ì¸ì§€ í™•ì¸
            const validTags = ['div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'header', 'nav', 'main', 'section', 'article', 'aside', 'footer',
                'ul', 'ol', 'li', 'a', 'img', 'button', 'input', 'textarea',
                'select', 'form', 'table', 'thead', 'tbody', 'tr', 'th', 'td'];

            if (!validTags.includes(newTagName.toLowerCase())) {
                alert('ìœ íš¨í•˜ì§€ ì•Šì€ HTML íƒœê·¸ëª…ì…ë‹ˆë‹¤.');
                return;
            }

            // ìƒˆ ìš”ì†Œ ìƒì„±
            const newElement = document.createElement(newTagName);

            // ê¸°ì¡´ ì†ì„±ë“¤ ë³µì‚¬ (class, id ë“±)
            for (let attr of oldElement.attributes) {
                if (attr.name !== 'data-drag-initialized') {
                    newElement.setAttribute(attr.name, attr.value);
                }
            }

            // ìì‹ ë…¸ë“œë“¤ ë³µì‚¬
            while (oldElement.firstChild) {
                newElement.appendChild(oldElement.firstChild);
            }

            // ê¸°ì¡´ ìš”ì†Œë¥¼ ìƒˆ ìš”ì†Œë¡œ êµì²´
            oldElement.parentNode.replaceChild(newElement, oldElement);

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            selectedElement = newElement;

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            reinitializeDragAndDrop();

            // ì†ì„± íŒ¨ë„ ë¨¼ì € ìˆ¨ê¸°ê¸°
            hidePropertyPanel();

            // ìƒˆ ìš”ì†Œ ì„ íƒ (ë” ê¸´ ì§€ì—°ì‹œê°„ìœ¼ë¡œ)
            setTimeout(() => {
                selectElement(newElement);
            }, 200);

            updateDebug(`TagName ë³€ê²½ë¨: ${newTagName}`);
        }

        // ì†ì„± íŒ¨ë„ í‘œì‹œ
        function showPropertyPanel(element, retryCount = 0) {
            const panel = document.getElementById('propertyPanel');
            const title = document.getElementById('selectedElementTitle');
            const tagNameInput = document.getElementById('tagNameInput');

            if (!panel || !title || !tagNameInput) {
                console.error('ì†ì„± íŒ¨ë„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { panel, title, tagNameInput });

                // ìµœëŒ€ 3ë²ˆê¹Œì§€ ì¬ì‹œë„
                if (retryCount < 3) {
                    setTimeout(() => {
                        showPropertyPanel(element, retryCount + 1);
                    }, 100 * (retryCount + 1)); // ì ì§„ì ìœ¼ë¡œ ì§€ì—°ì‹œê°„ ì¦ê°€
                }
                return;
            }

            panel.classList.add('active');
            title.textContent = `ì„ íƒëœ ìš”ì†Œ: <${element.tagName.toLowerCase()}> (${element.id || 'no-id'})`;

            // í…ìŠ¤íŠ¸ ë…¸ë“œ ì„ íƒ í•´ì œ
            selectedTextNode = null;

            // ëª¨ë“  ìš”ì†Œ ê´€ë ¨ UI í‘œì‹œ
            const allPropertyRows = panel.querySelectorAll('.property-row');
            allPropertyRows.forEach(row => {
                if (row.id !== 'textNodeRow') {
                    row.style.display = 'block';
                }
            });

            // í…ìŠ¤íŠ¸ ë…¸ë“œ UI ìˆ¨ê¸°ê¸°
            const textNodeRow = document.getElementById('textNodeRow');
            if (textNodeRow) textNodeRow.style.display = 'none';

            // ì†ì„± ëª©ë¡ê³¼ ìì‹ ëª©ë¡ í‘œì‹œ
            const attributesList = document.getElementById('attributesList');
            const childrenList = document.getElementById('childrenList');

            if (attributesList && attributesList.parentElement) {
                attributesList.parentElement.style.display = 'block';
            }
            if (childrenList && childrenList.parentElement) {
                childrenList.parentElement.style.display = 'block';
            }

            // tagNameInputì´ ì¡´ì¬í•˜ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
            if (tagNameInput) {
                tagNameInput.value = element.tagName.toLowerCase();
            }



            updateAttributesList(element);
            updateChildrenList(element);
        }

        // ì†ì„± íŒ¨ë„ ìˆ¨ê¹€
        function hidePropertyPanel() {
            const panel = document.getElementById('propertyPanel');
            panel.classList.remove('active');
        }

        // ì†ì„± ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAttributesList(element) {
            const attributesList = document.getElementById('attributesList');
            if (!attributesList) {
                console.error('attributesList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            attributesList.innerHTML = '';

            if (element.attributes.length === 0) {
                attributesList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            for (let attr of element.attributes) {
                if (attr.name === 'data-drag-initialized') continue; // ë‚´ë¶€ ì†ì„± ì œì™¸

                const attrItem = document.createElement('div');
                attrItem.className = 'attribute-item';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = attr.name;
                nameInput.placeholder = 'ì†ì„±ëª…';
                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        updateAttribute(element, attr.name, nameInput.value, valueInput.value);
                    }
                });

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = attr.value;
                valueInput.placeholder = 'ì†ì„±ê°’';
                valueInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        updateAttribute(element, attr.name, nameInput.value, valueInput.value);
                    }
                });

                const updateBtn = document.createElement('button');
                updateBtn.className = 'btn-primary';
                updateBtn.textContent = 'ìˆ˜ì •';
                updateBtn.onclick = () => updateAttribute(element, attr.name, nameInput.value, valueInput.value);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-danger';
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.onclick = () => deleteAttribute(element, attr.name);

                attrItem.appendChild(nameInput);
                attrItem.appendChild(valueInput);
                attrItem.appendChild(updateBtn);
                attrItem.appendChild(deleteBtn);
                attributesList.appendChild(attrItem);
            }
        }

        // TagName ì—…ë°ì´íŠ¸ (ì†ì„± íŒ¨ë„ì—ì„œ)
        function updateTagName() {
            if (!selectedElement) return;

            const tagNameInput = document.getElementById('tagNameInput');
            if (!tagNameInput) {
                console.error('tagNameInputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const newTagName = tagNameInput.value.trim();
            if (!newTagName) {
                alert('íƒœê·¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            changeElementTagName(selectedElement, newTagName);
        }



        // ìƒˆ ì†ì„± ì¶”ê°€
        function addAttribute() {
            if (!selectedElement) return;

            const nameInput = document.getElementById('newAttrName');
            const valueInput = document.getElementById('newAttrValue');
            const name = nameInput.value.trim();
            const value = valueInput.value.trim();

            if (!name) {
                alert('ì†ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            selectedElement.setAttribute(name, value);
            nameInput.value = '';
            valueInput.value = '';

            updateAttributesList(selectedElement);
            updateDebug(`ì†ì„± ì¶”ê°€: ${name}="${value}"`);
        }

        // ì†ì„± ì—…ë°ì´íŠ¸
        function updateAttribute(element, oldName, newName, newValue) {
            if (oldName !== newName) {
                // ì†ì„±ëª…ì´ ë³€ê²½ëœ ê²½ìš°
                element.removeAttribute(oldName);
                if (newName.trim()) {
                    element.setAttribute(newName.trim(), newValue);
                }
            } else {
                // ì†ì„±ê°’ë§Œ ë³€ê²½ëœ ê²½ìš°
                element.setAttribute(oldName, newValue);
            }

            updateAttributesList(element);
            updateDebug(`ì†ì„± ìˆ˜ì •: ${newName}="${newValue}"`);
        }

        // ì†ì„± ì‚­ì œ
        function deleteAttribute(element, attrName) {
            if (confirm(`ì†ì„± "${attrName}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                element.removeAttribute(attrName);
                updateAttributesList(element);
                updateDebug(`ì†ì„± ì‚­ì œ: ${attrName}`);
            }
        }

        // ìì‹ ìš”ì†Œ ëª©ë¡ ì—…ë°ì´íŠ¸ (í…ìŠ¤íŠ¸ ë…¸ë“œ í¬í•¨)
        function updateChildrenList(element) {
            console.log('updateChildrenList í˜¸ì¶œë¨:', element);
            const childrenList = document.getElementById('childrenList');
            if (!childrenList) {
                console.error('childrenList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            childrenList.innerHTML = '';

            // ëª¨ë“  ìì‹ ë…¸ë“œ (ìš”ì†Œ + í…ìŠ¤íŠ¸ ë…¸ë“œ)
            const allChildren = Array.from(element.childNodes);
            const relevantChildren = allChildren.filter(child => {
                if (child.nodeType === Node.ELEMENT_NODE) {
                    return child.classList.contains('draggable') || child === rootContainer;
                } else if (child.nodeType === Node.TEXT_NODE) {
                    return child.textContent.trim().length > 0; // ë¹ˆ í…ìŠ¤íŠ¸ ë…¸ë“œ ì œì™¸
                }
                return false;
            });

            console.log('ê´€ë ¨ ìì‹ë“¤:', relevantChildren.length, relevantChildren);

            if (relevantChildren.length === 0) {
                childrenList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">ìì‹ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            relevantChildren.forEach((child, index) => {
                const childItem = document.createElement('div');
                childItem.className = 'child-item';

                const childInfo = document.createElement('div');
                childInfo.className = 'child-info';

                if (child.nodeType === Node.ELEMENT_NODE) {
                    // ìš”ì†Œ ë…¸ë“œ
                    const displayName = child.id || 'no-name';
                    const textPreview = child.textContent.substring(0, 20);
                    childInfo.innerHTML = `
                        <span style="color: #007bff;">ğŸ“„ ${child.tagName.toLowerCase()}</span>
                        <span style="color: #007bff; font-weight: bold;">${displayName}</span>
                        ${textPreview ? `<span style="color: #28a745;">${textPreview}${child.textContent.length > 20 ? '...' : ''}</span>` : ''}
                    `;
                } else if (child.nodeType === Node.TEXT_NODE) {
                    // í…ìŠ¤íŠ¸ ë…¸ë“œ - ì§ì ‘ í¸ì§‘ ê°€ëŠ¥í•œ textareaë¡œ í‘œì‹œ
                    const textContent = child.textContent.trim();
                    const textarea = document.createElement('textarea');
                    textarea.style.cssText = 'color: #28a745; font-style: italic; border: 1px solid #ddd; border-radius: 3px; padding: 4px; resize: vertical; min-height: 20px; width: 200px; margin-left: 10px;';
                    textarea.value = textContent;
                    textarea.setAttribute('data-text-node-index', index);

                    textarea.onblur = function () {
                        updateTextNodeContent(this);
                    };

                    textarea.onkeydown = function (event) {
                        if (event.key === 'Enter' && !event.shiftKey) {
                            event.preventDefault();
                            this.blur();
                        }
                    };

                    childInfo.innerHTML = '<span style="color: #6c757d;">ğŸ“ TEXT_NODE</span>';
                    childInfo.appendChild(textarea);
                }

                const childActions = document.createElement('div');
                childActions.className = 'child-actions';

                // ê³µí†µ ì´ë™ ë²„íŠ¼ë“¤
                const upBtn = document.createElement('button');
                upBtn.className = 'btn-secondary';
                upBtn.textContent = 'â†‘';
                upBtn.style.fontSize = '12px';
                upBtn.style.padding = '4px 6px';
                upBtn.style.marginRight = '2px';
                upBtn.onclick = () => moveChildUp(child, index);

                const downBtn = document.createElement('button');
                downBtn.className = 'btn-secondary';
                downBtn.textContent = 'â†“';
                downBtn.style.fontSize = '12px';
                downBtn.style.padding = '4px 6px';
                downBtn.style.marginRight = '5px';
                downBtn.onclick = () => moveChildDown(child, index);

                childActions.appendChild(upBtn);
                childActions.appendChild(downBtn);

                if (child.nodeType === Node.TEXT_NODE) {
                    // í…ìŠ¤íŠ¸ ë…¸ë“œëŠ” ì €ì¥ê³¼ ì‚­ì œ ë²„íŠ¼
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'btn-success';
                    saveBtn.textContent = 'ğŸ’¾';
                    saveBtn.style.fontSize = '12px';
                    saveBtn.style.padding = '4px 6px';
                    saveBtn.style.marginRight = '2px';
                    saveBtn.onclick = () => {
                        const textarea = childItem.querySelector('textarea');
                        if (textarea) updateTextNodeContent(textarea);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-danger';
                    deleteBtn.textContent = 'ğŸ—‘ï¸';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.style.padding = '4px 6px';
                    deleteBtn.onclick = () => deleteTextNode(child);

                    childActions.appendChild(saveBtn);
                    childActions.appendChild(deleteBtn);
                } else {
                    // ìš”ì†Œ ë…¸ë“œëŠ” ì„ íƒê³¼ ì‚­ì œ ë²„íŠ¼
                    const selectBtn = document.createElement('button');
                    selectBtn.className = 'btn-primary';
                    selectBtn.textContent = 'ì„ íƒ';
                    selectBtn.style.fontSize = '12px';
                    selectBtn.style.padding = '4px 8px';
                    selectBtn.style.marginRight = '2px';
                    selectBtn.onclick = () => selectElement(child);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-danger';
                    deleteBtn.textContent = 'ğŸ—‘ï¸';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.style.padding = '4px 6px';
                    deleteBtn.onclick = () => deleteChildElement(child);

                    childActions.appendChild(selectBtn);
                    childActions.appendChild(deleteBtn);
                }

                childItem.appendChild(childInfo);
                childItem.appendChild(childActions);
                childrenList.appendChild(childItem);
            });
        }

        // ìì‹ ìš”ì†Œ ì¶”ê°€
        function addChildElement() {
            if (!selectedElement) {
                alert('ìš”ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const tagName = 'div'; // ê¸°ë³¸ê°’ìœ¼ë¡œ div ì‚¬ìš©
            const newElement = document.createElement(tagName);
            newElement.className = 'draggable';
            newElement.id = `new-${Date.now()}`;
            // textContentëŠ” ë¹„ì›Œë‘  - ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥


            selectedElement.appendChild(newElement);
            reinitializeDragAndDrop();
            updateChildrenList(selectedElement);
            updateDebug(`ìì‹ ìš”ì†Œ ì¶”ê°€: ${tagName}`);
        }

        // ìì‹ ìš”ì†Œ ì‚­ì œ
        function deleteChildElement(element) {
            if (confirm(`"${element.id || element.tagName}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const parent = element.parentElement;
                element.remove();

                if (selectedElement === element) {
                    deselectElement();
                }

                if (parent) {
                    updateChildrenList(parent);
                }
                updateDebug(`ìš”ì†Œ ì‚­ì œ: ${element.id || element.tagName}`);
            }
        }

        // ì„ íƒëœ ìš”ì†Œ ì‚­ì œ
        function deleteSelectedElement() {
            if (!selectedElement) {
                alert('ì‚­ì œí•  ìš”ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (selectedElement === rootContainer) {
                alert('ì‘ì—… ì˜ì—­ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            deleteChildElement(selectedElement);
        }

        // ìš”ì†Œë¥¼ ìœ„ë¡œ ì´ë™
        function moveElementUp() {
            if (!selectedElement || selectedElement === rootContainer) {
                alert('ì´ë™í•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const parent = selectedElement.parentElement;
            const previousSibling = selectedElement.previousElementSibling;

            if (previousSibling) {
                parent.insertBefore(selectedElement, previousSibling);
                updateDebug('ìš”ì†Œë¥¼ ìœ„ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');

                // ë¶€ëª¨ì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
                if (parent && parent.classList.contains('draggable')) {
                    updateChildrenList(parent);
                }
            } else {
                alert('ì´ë¯¸ ì²« ë²ˆì§¸ ìœ„ì¹˜ì…ë‹ˆë‹¤.');
            }
        }

        // ìš”ì†Œë¥¼ ì•„ë˜ë¡œ ì´ë™
        function moveElementDown() {
            if (!selectedElement || selectedElement === rootContainer) {
                alert('ì´ë™í•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const parent = selectedElement.parentElement;
            const nextSibling = selectedElement.nextElementSibling;

            if (nextSibling) {
                parent.insertBefore(nextSibling, selectedElement);
                updateDebug('ìš”ì†Œë¥¼ ì•„ë˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');

                // ë¶€ëª¨ì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
                if (parent && parent.classList.contains('draggable')) {
                    updateChildrenList(parent);
                }
            } else {
                alert('ì´ë¯¸ ë§ˆì§€ë§‰ ìœ„ì¹˜ì…ë‹ˆë‹¤.');
            }
        }

        // ìš”ì†Œë¥¼ ìƒìœ„ë¡œ ì´ë™ (ë¶€ëª¨ì˜ í˜•ì œë¡œ)
        function moveToParent() {
            if (!selectedElement || selectedElement === rootContainer) {
                alert('ì´ë™í•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const parent = selectedElement.parentElement;
            const grandParent = parent.parentElement;

            if (!grandParent) {
                alert('ë” ì´ìƒ ìƒìœ„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë¶€ëª¨ ë‹¤ìŒì— ì‚½ì…
            if (parent.nextElementSibling) {
                grandParent.insertBefore(selectedElement, parent.nextElementSibling);
            } else {
                grandParent.appendChild(selectedElement);
            }

            updateDebug('ìš”ì†Œë¥¼ ìƒìœ„ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');

            // ê¸°ì¡´ ë¶€ëª¨ì™€ ìƒˆ ë¶€ëª¨ì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (parent.classList.contains('draggable')) {
                updateChildrenList(parent);
            }
            if (grandParent.classList.contains('draggable') || grandParent === rootContainer) {
                updateChildrenList(grandParent);
            }
        }

        // ìœ„ìª½ í˜•ì œ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™
        function moveToUpperSibling() {
            if (!selectedElement || selectedElement === rootContainer) {
                alert('ì´ë™í•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const previousSibling = selectedElement.previousElementSibling;

            if (!previousSibling) {
                alert('ìœ„ìª½ì— í˜•ì œ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const oldParent = selectedElement.parentElement;
            previousSibling.appendChild(selectedElement);

            updateDebug('ìš”ì†Œë¥¼ ìœ„ìª½ í˜•ì œì˜ ìì‹ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');

            // ê¸°ì¡´ ë¶€ëª¨ì™€ ìƒˆ ë¶€ëª¨ì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (oldParent && oldParent.classList.contains('draggable')) {
                updateChildrenList(oldParent);
            }
            updateChildrenList(previousSibling);
        }

        // ì•„ë˜ìª½ í˜•ì œ ìš”ì†Œì˜ ìì‹ìœ¼ë¡œ ì´ë™
        function moveToLowerSibling() {
            if (!selectedElement || selectedElement === rootContainer) {
                alert('ì´ë™í•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const nextSibling = selectedElement.nextElementSibling;

            if (!nextSibling) {
                alert('ì•„ë˜ìª½ì— í˜•ì œ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const oldParent = selectedElement.parentElement;
            nextSibling.appendChild(selectedElement);

            updateDebug('ìš”ì†Œë¥¼ ì•„ë˜ìª½ í˜•ì œì˜ ìì‹ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');

            // ê¸°ì¡´ ë¶€ëª¨ì™€ ìƒˆ ë¶€ëª¨ì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (oldParent && oldParent.classList.contains('draggable')) {
                updateChildrenList(oldParent);
            }
            updateChildrenList(nextSibling);
        }

        // í…ìŠ¤íŠ¸ ë…¸ë“œ ì„ íƒ
        let selectedTextNode = null;

        function selectTextNode(textNode) {
            // í…ìŠ¤íŠ¸ ë…¸ë“œëŠ” ì´ì œ ì§ì ‘ í¸ì§‘ ê°€ëŠ¥í•˜ë¯€ë¡œ ì„ íƒ ê¸°ëŠ¥ ë¶ˆí•„ìš”
            updateDebug(`í…ìŠ¤íŠ¸ ë…¸ë“œ: "${textNode.textContent.substring(0, 20)}..." (ì§ì ‘ í¸ì§‘ ê°€ëŠ¥)`);
        }





        // í…ìŠ¤íŠ¸ ë‚´ìš© ì—…ë°ì´íŠ¸
        function updateTextContent() {
            if (!selectedTextNode) return;

            const textContentInput = document.getElementById('textContentInput');
            if (!textContentInput) {
                console.error('textContentInputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const newContent = textContentInput.value;
            selectedTextNode.textContent = newContent;

            updateDebug(`í…ìŠ¤íŠ¸ ë‚´ìš© ì—…ë°ì´íŠ¸: "${newContent.substring(0, 20)}..."`);

            // ë¶€ëª¨ ìš”ì†Œì˜ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (selectedTextNode.parentElement) {
                updateChildrenList(selectedTextNode.parentElement);
            }
        }

        // í…ìŠ¤íŠ¸ ë…¸ë“œ ì‚­ì œ
        function deleteTextNode(textNode) {
            if (confirm(`í…ìŠ¤íŠ¸ ë…¸ë“œ "${textNode.textContent.substring(0, 30)}..."ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const parent = textNode.parentElement;
                textNode.remove();

                if (selectedTextNode === textNode) {
                    selectedTextNode = null;
                    hidePropertyPanel();
                }

                if (parent) {
                    updateChildrenList(parent);
                }
                updateDebug('í…ìŠ¤íŠ¸ ë…¸ë“œ ì‚­ì œë¨');
            }
        }

        // í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€
        function addTextNode() {
            if (!selectedElement) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìš”ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const textContent = prompt('ì¶”ê°€í•  í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ í…ìŠ¤íŠ¸');
            if (textContent === null) return;

            const textNode = document.createTextNode(textContent);
            selectedElement.appendChild(textNode);

            updateChildrenList(selectedElement);
            updateDebug(`í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€: "${textContent}"`);
        }

        // í…ìŠ¤íŠ¸ ë…¸ë“œ ë‚´ìš© ì§ì ‘ ì—…ë°ì´íŠ¸
        function updateTextNodeContent(textarea) {
            console.log('updateTextNodeContent í˜¸ì¶œë¨:', textarea.value);
            const newContent = textarea.value;
            const index = parseInt(textarea.getAttribute('data-text-node-index'));

            // í˜„ì¬ ì„ íƒëœ ìš”ì†Œì˜ ìì‹ ë…¸ë“œë“¤ ì¤‘ì—ì„œ í•´ë‹¹ í…ìŠ¤íŠ¸ ë…¸ë“œ ì°¾ê¸°
            const parentContainer = selectedElement || rootContainer;
            const allChildren = Array.from(parentContainer.childNodes).filter(child => {
                if (child.nodeType === Node.ELEMENT_NODE) {
                    return child.classList.contains('draggable') || child === rootContainer;
                } else if (child.nodeType === Node.TEXT_NODE) {
                    return child.textContent.trim().length > 0;
                }
                return false;
            });

            console.log('ì°¾ì€ ìì‹ë“¤:', allChildren.length, 'ì¸ë±ìŠ¤:', index);
            const targetTextNode = allChildren[index];
            if (targetTextNode && targetTextNode.nodeType === Node.TEXT_NODE) {
                targetTextNode.textContent = newContent;
                updateDebug(`í…ìŠ¤íŠ¸ ë…¸ë“œ ì—…ë°ì´íŠ¸: "${newContent}"`);
                console.log('í…ìŠ¤íŠ¸ ë…¸ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } else {
                console.error('í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', targetTextNode);
            }
        }

        // ìì‹ ë…¸ë“œ ìœ„ë¡œ ì´ë™
        function moveChildUp(child, index) {
            const parent = child.parentElement;
            if (!parent || index === 0) return; // ì´ë¯¸ ì²« ë²ˆì§¸ì´ë©´ ì´ë™ ë¶ˆê°€

            const allChildren = Array.from(parent.childNodes).filter(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    return node.classList.contains('draggable') || node === rootContainer;
                } else if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent.trim().length > 0;
                }
                return false;
            });

            const previousChild = allChildren[index - 1];
            if (previousChild) {
                parent.insertBefore(child, previousChild);
                updateChildrenList(parent);
                updateDebug('ìì‹ ë…¸ë“œë¥¼ ìœ„ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìì‹ ë…¸ë“œ ì•„ë˜ë¡œ ì´ë™
        function moveChildDown(child, index) {
            const parent = child.parentElement;
            if (!parent) return;

            const allChildren = Array.from(parent.childNodes).filter(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    return node.classList.contains('draggable') || node === rootContainer;
                } else if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent.trim().length > 0;
                }
                return false;
            });

            if (index >= allChildren.length - 1) return; // ì´ë¯¸ ë§ˆì§€ë§‰ì´ë©´ ì´ë™ ë¶ˆê°€

            const nextChild = allChildren[index + 1];
            if (nextChild && nextChild.nextSibling) {
                parent.insertBefore(child, nextChild.nextSibling);
            } else {
                parent.appendChild(child);
            }
            updateChildrenList(parent);
            updateDebug('ìì‹ ë…¸ë“œë¥¼ ì•„ë˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
        }

        // ìš”ì†Œ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleElementClick(e) {
            console.log('í´ë¦­ ì´ë²¤íŠ¸:', e.target, e.currentTarget);

            // ë“œë˜ê·¸ ì¤‘ì´ë©´ í´ë¦­ ë¬´ì‹œ
            if (isDragging) return;

            // Root Container í´ë¦­ í™•ì¸ (ë¹ˆ ê³µê°„ í´ë¦­)
            if (e.currentTarget === rootContainer) {
                // ì‹¤ì œë¡œ í´ë¦­ëœ ìš”ì†Œê°€ draggableì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Root Container ì„ íƒ
                const clickedDraggable = e.target.closest('.draggable');
                if (!clickedDraggable) {
                    console.log('Root Container ë¹ˆ ê³µê°„ í´ë¦­ë¨');
                    e.stopPropagation();

                    if (selectedElement === rootContainer) {
                        // ì´ë¯¸ ì„ íƒëœ Root Containerë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
                        deselectElement();
                    } else {
                        // Root Container ì„ íƒ
                        selectElement(rootContainer);
                    }
                    return;
                }
            }

            // draggable ìš”ì†Œ í´ë¦­ í™•ì¸
            if (e.currentTarget.classList.contains('draggable')) {
                console.log('Draggable ìš”ì†Œ í´ë¦­ë¨:', e.currentTarget.id);
                e.stopPropagation();

                const clickedElement = e.currentTarget;
                if (selectedElement === clickedElement) {
                    // ì´ë¯¸ ì„ íƒëœ ìš”ì†Œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
                    deselectElement();
                } else {
                    // ìƒˆ ìš”ì†Œ ì„ íƒ
                    selectElement(clickedElement);
                }
            }
        }

        // ë°°ê²½ í´ë¦­ì‹œ ì„ íƒ í•´ì œ
        function handleBackgroundClick(e) {
            // Root Container í´ë¦­ì€ handleElementClickì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
            if (e.target === document.body) {
                deselectElement();
            }
        }

        // ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ì• ë‹ˆë©”ì´ì…˜
        function animateElementMove(element, direction, callback) {
            console.log('ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘:', element.id, direction);

            // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
            const startRect = element.getBoundingClientRect();

            // ì‹¤ì œ DOM ì´ë™ ì‹¤í–‰
            callback();

            // ì´ë™ í›„ ìœ„ì¹˜ ê³„ì‚°
            const endRect = element.getBoundingClientRect();

            // ì´ë™ ê±°ë¦¬ ê³„ì‚°
            const deltaX = startRect.left - endRect.left;
            const deltaY = startRect.top - endRect.top;

            console.log('ì´ë™ ê±°ë¦¬:', deltaX, deltaY);

            // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            if (Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2) {
                console.log('ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ ì¤‘...');

                // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì„¤ì •
                element.style.transition = 'none';
                element.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                element.style.zIndex = '999';
                element.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.2)';

                // í•œ í”„ë ˆì„ ëŒ€ê¸° í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                requestAnimationFrame(() => {
                    element.style.transition = 'all 0.5s ease-out';
                    element.style.transform = 'translate(0, 0)';

                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì •ë¦¬
                    setTimeout(() => {
                        element.style.transition = '';
                        element.style.transform = '';
                        element.style.zIndex = '';
                        element.style.boxShadow = '';
                        console.log('ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ');
                    }, 500);
                });
            } else {
                console.log('ì´ë™ ê±°ë¦¬ê°€ ì‘ì•„ì„œ ì• ë‹ˆë©”ì´ì…˜ ìƒëµ');
            }
        }

        // ìš”ì†Œ ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜
        function animateElementDelete(element, callback) {
            element.classList.add('slide-out');

            setTimeout(() => {
                callback();
            }, 300);
        }

        // ìƒˆ ìš”ì†Œ ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜
        function animateElementAdd(element) {
            element.classList.add('slide-in');
            setTimeout(() => {
                element.classList.remove('slide-in');
            }, 400);
        }



        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜
        function animateDragDrop(draggedElement, targetElement, position, callback) {
            console.log('ë“œë˜ê·¸ ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘');

            // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
            const startRect = draggedElement.getBoundingClientRect();

            // ì‹¤ì œ DOM ì´ë™ ì‹¤í–‰
            callback();

            // ì´ë™ í›„ ìœ„ì¹˜ ê³„ì‚°
            const endRect = draggedElement.getBoundingClientRect();

            // ì´ë™ ê±°ë¦¬ ê³„ì‚°
            const deltaX = startRect.left - endRect.left;
            const deltaY = startRect.top - endRect.top;

            console.log('ë“œë˜ê·¸ ë“œë¡­ ì´ë™ ê±°ë¦¬:', deltaX, deltaY);

            // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            if (Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2) {
                console.log('ë“œë˜ê·¸ ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ ì¤‘...');

                // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì„¤ì •
                draggedElement.style.transition = 'none';
                draggedElement.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                draggedElement.style.zIndex = '999';
                draggedElement.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.2)';

                // í•œ í”„ë ˆì„ ëŒ€ê¸° í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                requestAnimationFrame(() => {
                    draggedElement.style.transition = 'all 0.5s ease-out';
                    draggedElement.style.transform = 'translate(0, 0)';

                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì •ë¦¬
                    setTimeout(() => {
                        draggedElement.style.transition = '';
                        draggedElement.style.transform = '';
                        draggedElement.style.zIndex = '';
                        draggedElement.style.boxShadow = '';
                        console.log('ë“œë˜ê·¸ ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ');
                    }, 500);
                });
            }
        }

        // ë°ì´í„° êµ¬ì¡° ì •ì˜
        // type El = {
        //     tagName: string,
        //     attributes: { [key: string]: string },
        //     children: El[]
        // }

        let itemCounter = 1000; // ìƒˆ ì•„ì´í…œ ID ìƒì„±ìš©

        // DOM ë…¸ë“œë¥¼ ë°ì´í„° êµ¬ì¡°ë¡œ ë³€í™˜
        function nodeToData(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                // í…ìŠ¤íŠ¸ ë…¸ë“œ
                const textContent = node.textContent.trim();
                if (!textContent) return null; // ë¹ˆ í…ìŠ¤íŠ¸ ë…¸ë“œëŠ” ë¬´ì‹œ

                return {
                    nodeType: 'TEXT_NODE',
                    textContent: textContent
                };
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                // action-buttonsëŠ” ë‚´ë¶€ UIì´ë¯€ë¡œ ì œì™¸
                if (node.classList && node.classList.contains('action-buttons')) {
                    return null;
                }

                // ì—˜ë¦¬ë¨¼íŠ¸ ë…¸ë“œ
                const data = {
                    nodeType: 'ELEMENT_NODE',
                    tagName: node.tagName.toLowerCase(),
                    attributes: {},
                    children: []
                };

                // ì†ì„± ë³µì‚¬ (ë‚´ë¶€ ì†ì„± ì œì™¸)
                for (let attr of node.attributes) {
                    // ë‚´ë¶€ ë“œë˜ê·¸ ì†ì„±ê³¼ ì„ íƒ ìƒíƒœëŠ” ì œì™¸
                    if (attr.name !== 'data-drag-initialized' && attr.name !== 'class' ||
                        (attr.name === 'class' && !attr.value.includes('selected'))) {
                        data.attributes[attr.name] = attr.value;
                    } else if (attr.name === 'class') {
                        // class ì†ì„±ì—ì„œ selected í´ë˜ìŠ¤ë§Œ ì œê±°
                        const cleanedClass = attr.value.replace(/\bselected\b/g, '').trim().replace(/\s+/g, ' ');
                        if (cleanedClass) {
                            data.attributes[attr.name] = cleanedClass;
                        }
                    }
                }

                // ëª¨ë“  ìì‹ ë…¸ë“œë“¤ì„ ì¬ê·€ì ìœ¼ë¡œ ë³€í™˜ (action-buttons ì œì™¸)
                for (let child of node.childNodes) {
                    // action-buttons ì»¨í…Œì´ë„ˆëŠ” ê±´ë„ˆë›°ê¸°
                    if (child.nodeType === Node.ELEMENT_NODE &&
                        child.classList && child.classList.contains('action-buttons')) {
                        continue;
                    }

                    const childData = nodeToData(child);
                    if (childData) {
                        data.children.push(childData);
                    }
                }

                return data;
            }

            return null; // ë‹¤ë¥¸ ë…¸ë“œ íƒ€ì…ì€ ë¬´ì‹œ
        }

        // í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼ í•¨ìˆ˜
        function elementToData(element) {
            return nodeToData(element);
        }

        // ë°ì´í„° êµ¬ì¡°ë¥¼ DOM ë…¸ë“œë¡œ ë³€í™˜
        function dataToNode(data) {
            if (data.nodeType === 'TEXT_NODE') {
                // í…ìŠ¤íŠ¸ ë…¸ë“œ ìƒì„±
                return document.createTextNode(data.textContent);
            } else if (data.nodeType === 'ELEMENT_NODE') {
                // ì—˜ë¦¬ë¨¼íŠ¸ ë…¸ë“œ ìƒì„±
                const element = document.createElement(data.tagName);

                // ì†ì„± ì„¤ì •
                for (let [key, value] of Object.entries(data.attributes)) {
                    element.setAttribute(key, value);
                }

                // ìì‹ ë…¸ë“œë“¤ ì¬ê·€ì ìœ¼ë¡œ ìƒì„±
                for (let childData of data.children) {
                    const childNode = dataToNode(childData);
                    if (childNode) {
                        element.appendChild(childNode);
                    }
                }

                return element;
            }

            return null;
        }

        // í˜¸í™˜ì„±ì„ ìœ„í•œ ë˜í¼ í•¨ìˆ˜ (ê¸°ì¡´ ë°ì´í„° êµ¬ì¡° ì§€ì›)
        function dataToElement(data) {
            // ìƒˆë¡œìš´ êµ¬ì¡°ì¸ì§€ í™•ì¸
            if (data.nodeType) {
                return dataToNode(data);
            }

            // ê¸°ì¡´ êµ¬ì¡° (data-text ë°©ì‹) ì§€ì›
            const element = document.createElement(data.tagName);

            // ì†ì„± ì„¤ì •
            for (let [key, value] of Object.entries(data.attributes)) {
                if (key === 'data-text') {
                    // í…ìŠ¤íŠ¸ ë‚´ìš©ì€ ë‚˜ì¤‘ì— ì„¤ì •
                    continue;
                }
                element.setAttribute(key, value);
            }

            // í…ìŠ¤íŠ¸ ë‚´ìš© ì„¤ì • (ê¸°ì¡´ ë°©ì‹)
            if (data.attributes['data-text']) {
                element.appendChild(document.createTextNode(data.attributes['data-text']));
            }

            // ìì‹ ìš”ì†Œë“¤ ì¬ê·€ì ìœ¼ë¡œ ìƒì„±
            for (let childData of data.children) {
                const childElement = dataToElement(childData);
                if (childElement) {
                    element.appendChild(childElement);
                }
            }

            return element;
        }

        // í˜„ì¬ êµ¬ì¡°ë¥¼ ë°ì´í„°ë¡œ ì €ì¥
        function saveData() {
            if (!rootContainer) {
                alert('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const draggableElements = Array.from(rootContainer.children).filter(child =>
                child.classList.contains('draggable')
            );

            const data = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                rootContainer: {
                    id: rootContainer.id,
                    className: rootContainer.className
                },
                elements: draggableElements.map(el => elementToData(el))
            };

            const jsonString = JSON.stringify(data, null, 2);

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `drag-drop-data-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateDebug(`ë°ì´í„° ì €ì¥ë¨: ${draggableElements.length}ê°œ ìš”ì†Œ`);
            console.log('ì €ì¥ëœ ë°ì´í„°:', data);
        }

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadData() {
            document.getElementById('fileInput').click();
        }

        // íŒŒì¼ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.elements || !Array.isArray(data.elements)) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    if (!rootContainer) {
                        throw new Error('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // Root Container ë‚´ì˜ ê¸°ì¡´ draggable ìš”ì†Œë“¤ ì œê±°
                    rootContainer.querySelectorAll('.draggable').forEach(el => el.remove());

                    // ìƒˆ ìš”ì†Œë“¤ ìƒì„± ë° Root Containerì— ì¶”ê°€
                    for (let elementData of data.elements) {
                        const element = dataToElement(elementData);
                        rootContainer.appendChild(element);
                    }

                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
                    reinitializeDragAndDrop();

                    updateDebug(`ë°ì´í„° ë¶ˆëŸ¬ì˜´: ${data.elements.length}ê°œ ìš”ì†Œ`);
                    console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:', data);

                } catch (error) {
                    alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    updateDebug('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                }
            };
            reader.readAsText(file);

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // ìƒˆ ì•„ì´í…œ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
        function addNewItem() {
            if (!rootContainer) {
                alert('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const newId = `item-${itemCounter++}`;
            const newItem = document.createElement('div');
            newItem.className = 'draggable';
            newItem.id = newId;
            newItem.textContent = `ğŸ“„ ìƒˆ ì•„ì´í…œ ${itemCounter - 1000}`;

            rootContainer.appendChild(newItem);

            // ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            animateElementAdd(newItem);

            reinitializeDragAndDrop();
            updateDebug(`ìƒˆ ì•„ì´í…œ ì¶”ê°€: ${newId}`);
        }

        // ë£¨íŠ¸ ì»¨í…Œì´ë„ˆì— í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€
        function addTextToRoot() {
            if (!rootContainer) {
                alert('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const textContent = prompt('ì¶”ê°€í•  í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ í…ìŠ¤íŠ¸');
            if (textContent === null) return;

            const textNode = document.createTextNode(textContent);
            rootContainer.appendChild(textNode);

            updateDebug(`ë£¨íŠ¸ì— í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ê°€: "${textContent}"`);

            // ë£¨íŠ¸ ì»¨í…Œì´ë„ˆê°€ ì„ íƒë˜ì–´ ìˆë‹¤ë©´ ìì‹ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (selectedElement === rootContainer) {
                updateChildrenList(rootContainer);
            }
        }

        // ì „ì²´ ì‚­ì œ
        function clearAll() {
            if (!rootContainer) {
                alert('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm('ëª¨ë“  ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                rootContainer.querySelectorAll('.draggable').forEach(el => el.remove());
                updateDebug('ëª¨ë“  ì•„ì´í…œ ì‚­ì œë¨');
            }
        }

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            const sampleData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                elements: [
                    {
                        nodeType: "ELEMENT_NODE",
                        tagName: "div",
                        attributes: {
                            class: "draggable",
                            id: "sample1"
                        },
                        children: [
                            {
                                nodeType: "TEXT_NODE",
                                textContent: "ğŸ“‹ í”„ë¡œì íŠ¸ ê´€ë¦¬"
                            }
                        ]
                    },
                    {
                        nodeType: "ELEMENT_NODE",
                        tagName: "div",
                        attributes: {
                            class: "draggable",
                            id: "sample2"
                        },
                        children: [
                            {
                                nodeType: "TEXT_NODE",
                                textContent: "ğŸ¯ ê°œë°œ ì‘ì—…"
                            },
                            {
                                nodeType: "ELEMENT_NODE",
                                tagName: "div",
                                attributes: {
                                    class: "draggable",
                                    id: "sample2-1"
                                },
                                children: [
                                    {
                                        nodeType: "TEXT_NODE",
                                        textContent: "ğŸ”§ ë°±ì—”ë“œ ê°œë°œ"
                                    }
                                ]
                            },
                            {
                                nodeType: "ELEMENT_NODE",
                                tagName: "div",
                                attributes: {
                                    class: "draggable",
                                    id: "sample2-2"
                                },
                                children: [
                                    {
                                        nodeType: "TEXT_NODE",
                                        textContent: "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        nodeType: "ELEMENT_NODE",
                        tagName: "div",
                        attributes: {
                            class: "draggable",
                            id: "sample3"
                        },
                        children: [
                            {
                                nodeType: "TEXT_NODE",
                                textContent: "ğŸ“š ë¬¸ì„œí™”"
                            }
                        ]
                    }
                ]
            };

            if (!rootContainer) {
                alert('Root containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ì¡´ ìš”ì†Œë“¤ ì œê±°
            rootContainer.querySelectorAll('.draggable').forEach(el => el.remove());

            // ìƒ˜í”Œ ë°ì´í„°ë¡œ ìš”ì†Œë“¤ ìƒì„±
            for (let elementData of sampleData.elements) {
                const element = dataToElement(elementData);
                rootContainer.appendChild(element);
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            reinitializeDragAndDrop();

            updateDebug(`ìƒ˜í”Œ ë°ì´í„° ë¡œë“œë¨: ${sampleData.elements.length}ê°œ ìš”ì†Œ`);
        }

        // ì´ˆê¸°í™”
        reinitializeDragAndDrop();
        updateDebug('ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¤€ë¹„ ì™„ë£Œ');
    </script>
</body>

</html>