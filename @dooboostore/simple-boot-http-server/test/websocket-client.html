<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <div class="display"></div>
    <button id="send-btn">send</button>
    <input id="file-input" type="file" multiple />
    <button id="file-send-btn">filesend</button>
    <button id="unsubscribe-btn">unsubscribe</button>
    <button id="global-unsubscribe-btn">global unsubscribe</button>
    <script src="./node_modules/@dooboostore/simple-boot-http-server/dist/umd-bundle/websocket-client.umd.js"></script>
    <script>
      const { WebSocketClient } = dooboostoreSimpleBootHttpServerWebSocketClient;
      console.log('-v->', WebSocketClient);
      const display = document.querySelector('.display');
      const sendButton = document.querySelector('#send-btn');
      const fileInput = document.querySelector('#file-input');
      const fileSendButton = document.querySelector('#file-send-btn');
      const unSubscribeButton = document.querySelector('#unsubscribe-btn');
      const globalUnSubscribeButton = document.querySelector('#global-unsubscribe-btn');

      const ws = new WebSocketClient('http://localhost:8080', {
        retryConnectionCount: Number.MAX_SAFE_INTEGER,
        retryConnectionDelay: 1000
      });
      // ws.subscribe(it => {
      //   console.log('global  data--->', it);
      // })
      // const globalSubscription = ws.subject('good').observable.subscribe((data)=>{
      //   console.log('good data--->', data);
      // })

      const subject = ws.subject('Symbol.for(UserService)://say', { type: 'intent' });
      const subscription = subject.observable.subscribe({
        next: data => {
          console.log('Received data:', data);
          const line = document.createElement('p');
          line.textContent = `received: ${JSON.stringify(data)}`;
          display.appendChild(line);
          if (data && data.office && data.office.photo instanceof Blob) {
            const img = document.createElement('img');
            const objectUrl = URL.createObjectURL(data.office.photo);
            img.src = objectUrl;
            img.alt = data.office.photo.name || 'photo';
            img.style.maxWidth = '240px';
            img.style.display = 'block';
            img.onload = () => URL.revokeObjectURL(objectUrl);
            display.appendChild(img);
          }
          return { zzzz: 222222222222222 };
        },
        event: (event, data, meta) => {
          console.log('--------->', event, data, meta);
          display.innerHTML += `<p>received:${event} ${JSON.stringify(data)}</p>`;
          return { zz: 'cccccccccc' };
        },
        // event: {
        //   gaga: (data, meta) => {
        //     console.log('Received data:', data);
        //     display.innerHTML += `<p>received: ${JSON.stringify(data)}</p>`;
        //     return {zzzz:235};
        //   }
        // },
        error: err => {
          console.error('WebSocket error:', err);
        }
      });
      sendButton.addEventListener('click', () => {
        subject.send({ ww: 'zz' });
      });
      fileSendButton.addEventListener('click', async () => {
        const files = Array.from(fileInput.files || []);
        if (files.length === 0) {
          return;
        }
        subject.send({
          name: 'zz',
          office: {
            photo: files[0]
          },
          attachments: files
        });
      });
      unSubscribeButton.addEventListener('click', () => {
        subscription.unsubscribe();
      });
      // globalUnSubscribeButton.addEventListener('click', () => {
      //   globalSubscription.unsubscribe();
      // })

      //
      // const ws = new WebSocket('ws://localhost:8080', ['zz', 'zzzzz'])
      //
      // ws.addEventListener('open', () => {
      //   display.innerHTML += '<p>connected</p>'
      // })
      //
      // ws.addEventListener('message', (event) => {
      //   display.innerHTML += `<p>received: ${event.data}</p>`
      // })
      //
      // button.addEventListener('click', () => {
      //   const data = {}
      //   ws.send('hello server')
      //   display.innerHTML += '<p>sent: hello server</p>'
      // })
    </script>
  </body>
</html>
